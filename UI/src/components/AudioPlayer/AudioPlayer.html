<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>现代化音频播放器</title>
    <style>
        /* 核心变量 */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --text: #374151;
            --text-light: #6b7280;
            --bg: #ffffff;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --shadow: rgba(59, 130, 246, 0.3);
            --trans: 0.2s ease;
        }
        
        button {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
        }
        
        /* 播放器容器 */
        .player-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 50;
        }
        
        /* 浮动球 */
        .player-ball {
            width: 64px;
            height: 64px;
            backdrop-filter: blur(20px);
            background: var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all var(--trans);
        }
        
        .player-ball:hover {
            transform: scale(1.1);
        }
        
        .player-ball.hidden {
            opacity: 0;
        }
        
        /* 面板 */
        .player-panel {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 320px;
            backdrop-filter: blur(20px);
            background: var(--bg);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            border-radius: 16px;
            margin: 0 8px 8px 0;
            transform-origin: bottom right;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.3s ease;
            display: none;
        }
        
        .player-panel.show {
            display: block;
            opacity: 1;
            transform: scale(1);
        }
        
        /* 头部和信息 */
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .track-info {
            flex: 1;
            min-width: 0;
        }
        
        .track-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .play-mode {
            font-size: 12px;
            color: var(--text-light);
        }
        
        /* 按钮样式 */
        .close-btn, .volume-btn {
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn {
            margin-left: 12px;
            width: 24px;
            height: 24px;
        }
        
        .close-btn:hover, .volume-btn:hover, 
        .control-btn:hover, .mode-btn:hover, .playlist-btn:hover {
            color: #111827;
        }
        
        /* 主控制区域 */
        .player-main {
            padding: 16px;
        }
        
        /* 进度条 */
        .progress-container {
            background: var(--border);
            height: 4px;
            border-radius: 2px;
            cursor: pointer;
            margin-bottom: 16px;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .progress-bar {
            background: var(--primary);
            height: 100%;
            border-radius: 2px;
            transition: width 0.1s ease;
        }
        
        /* 时间显示 */
        .time-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 16px;
        }
        
        /* 控制按钮 */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            margin-bottom: 16px;
        }
        
        .control-btn {
            color: var(--text);
            padding: 8px;
            border-radius: 8px;
            transition: all var(--trans);
        }
        
        .control-btn:hover, .play-btn:hover {
            transform: scale(1.05);
        }
        
        .control-btn:active, .play-btn:active {
            transform: scale(0.95);
        }
        
        .play-btn {
            background: var(--primary);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all var(--trans);
        }
        
        .play-btn:hover {
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        
        .play-btn .icon-svg-play {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 底部控制 */
        .bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mode-btn, .playlist-btn {
            color: var(--text-light);
            padding: 8px;
            border-radius: 8px;
            transition: all var(--trans);
        }
        
        .mode-btn:hover, .playlist-btn:hover, .playlist-btn.active {
            background: #f3f4f6;
        }
        
        /* 音量控制 */
        .volume-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            margin: 0 16px;
        }
        
        .volume-slider-wrapper {
            flex: 1;
            height: 24px;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .volume-slider-container {
            position: relative;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        
        .volume-slider-fill {
            position: absolute;
            height: 100%;
            left: 0;
            top: 0;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.1s ease;
        }
        
        .volume-display {
            font-size: 12px;
            color: var(--text-light);
            width: 32px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        /* 滑块样式 */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
            position: absolute;
            z-index: 10;
            margin: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-runnable-track {
            background: transparent;
            height: 6px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            background: var(--primary);
            height: 14px;
            width: 14px;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 2px 4px var(--shadow);
            transition: all var(--trans);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        input[type="range"]::-moz-range-track {
            background: transparent;
            height: 6px;
            border: none;
        }
        
        input[type="range"]::-moz-range-thumb {
            background: var(--primary);
            height: 14px;
            width: 14px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px var(--shadow);
        }
        
        /* 播放列表 */
        .playlist-container {
            position: relative;
        }
        
        .playlist-popup {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 8px;
            width: 288px;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.95);
            transition: all var(--trans);
            display: none;
        }
        
        .playlist-popup.show {
            display: block;
            opacity: 1;
            transform: scale(1);
        }
        
        .playlist-header {
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .playlist-content {
            max-height: 192px;
            overflow-y: auto;
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin: 4px 8px;
            transition: all var(--trans);
        }
        
        .playlist-item:hover, .playlist-item.active {
            background: rgba(255, 255, 255, 0.6);
        }
        
        .playlist-item.active {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .playlist-number {
            font-size: 12px;
            color: #9ca3af;
            width: 24px;
            display: flex;
            align-items: center;
        }
        
        .playlist-title {
            flex: 1;
            font-size: 14px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 8px;
            display: flex;
            align-items: center;
        }
        
        .playlist-playing {
            font-size: 12px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            margin-left: 4px;
        }
        
        .playlist-item.active .playlist-title {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        /* 图标样式 */
        .icon-svg, .icon-svg-lg, .icon-svg-play {
            width: 16px;
            height: 16px;
            fill: currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
        }
        
        .icon-svg-lg {
            width: 20px;
            height: 20px;
        }
        
        .icon-svg-play {
            width: 18px;
            height: 18px;
        }
        
        /* 隐藏元素 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    
    <!-- 隐藏的音频元素 -->
    <audio id="audioElement"></audio>
    
    <!-- 音频播放器容器 -->
    <div class="player-container">
        <!-- 浮动小球 -->
        <div id="playerBall" class="player-ball">
            <div id="ballIcon"></div>
        </div>
        
        <!-- 展开的播放器面板 -->
        <div id="playerPanel" class="player-panel">
            <!-- 头部 -->
            <div class="player-header">
                <div class="track-info">
                    <div class="track-title" id="trackTitle">未选择音频</div>
                    <div class="play-mode" id="playModeText">列表循环</div>
                </div>
                <button class="close-btn" id="closeBtn">✕</button>
            </div>
        
            <!-- 主控制区域 -->
            <div class="player-main">
                <!-- 进度条 -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                
                <!-- 时间显示 -->
                <div class="time-display">
                    <span id="currentTimeDisplay">0:00</span>
                    <span id="durationDisplay">0:00</span>
                </div>
                
                <!-- 播放控制按钮 -->
                <div class="controls">
                    <button class="control-btn" id="prevBtn"></button>
                    <button class="play-btn" id="playBtn">
                        <div id="playBtnIcon"></div>
                    </button>
                    <button class="control-btn" id="nextBtn"></button>
                </div>
                
                <!-- 底部控制 -->
                <div class="bottom-controls">
                    <!-- 播放模式 -->
                    <button class="mode-btn" id="modeBtn" title="列表循环"></button>
                    
                    <!-- 音量控制 -->
                    <div class="volume-controls">
                        <button class="volume-btn" id="volumeBtn"></button>
                        <div class="volume-slider-wrapper">
                            <div class="volume-slider-container">
                                <div class="volume-slider-fill" id="volumeFill"></div>
                                <input type="range" min="0" max="100" step="1" value="70" id="volumeSlider">
                            </div>
                        </div>
                        <span class="volume-display" id="volumeDisplay">70</span>
                    </div>
                    
                    <!-- 播放列表按钮 -->
                    <div class="playlist-container">
                        <button class="playlist-btn" id="playlistBtn"></button>
                        
                        <!-- 播放列表弹出框 -->
                        <div id="playlistPopup" class="playlist-popup">
                            <div class="playlist-header">播放列表</div>
                            <div class="playlist-content" id="playlistContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========== 数据层 (Data Layer) ==========
        
        // 常量配置
        const AUDIO_CONFIG = {
            FILES: [
                'July - Rhapsody.mp3',
                'yutaka hirasaka - eternal moment.mp3'
            ],
            MODES: {
                LIST_LOOP: 'LIST_LOOP',
                SINGLE_LOOP: 'SINGLE_LOOP', 
                SEQUENTIAL: 'SEQUENTIAL',
                RANDOM: 'RANDOM'
            },
            STATES: {
                STOPPED: 'STOPPED',
                PLAYING: 'PLAYING',
                PAUSED: 'PAUSED',
                LOADING: 'LOADING'
            },
            MODE_TEXT: {
                LIST_LOOP: '列表循环',
                SINGLE_LOOP: '单曲循环',
                SEQUENTIAL: '顺序播放',
                RANDOM: '随机播放'
            }
        };
        
        // SVG 图标服务
        const IconService = {
            play: '<svg class="icon-svg-play" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 15L8 18L8 6L13 9L13 15M13 9L18 12L18 12L13 15L13 9"/></svg>',
            pause: '<svg class="icon-svg-play" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 19q-.825 0-1.412-.587T14 17V7q0-.825.588-1.412T16 5t1.413.588T18 7v10q0 .825-.587 1.413T16 19m-8 0q-.825 0-1.412-.587T6 17V7q0-.825.588-1.412T8 5t1.413.588T10 7v10q0 .825-.587 1.413T8 19"/></svg>',
            previous: '<svg class="icon-svg-lg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M14 3.002a1 1 0 0 0-1.578-.816l-7 4.963a1 1 0 0 0-.007 1.628l7 5.037A1 1 0 0 0 14 13.003zM2 2.5a.5.5 0 0 1 1 0v11a.5.5 0 0 1-1 0z"/></svg>',
            next: '<svg class="icon-svg-lg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2 3.002a1 1 0 0 1 1.578-.816l7 4.963a1 1 0 0 1 .007 1.628l-7 5.037A1 1 0 0 1 2 13.003zM14 2.5a.5.5 0 1 0-1 0v11a.5.5 0 0 0 1 0z"/></svg>',
            list: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 9V7h14v2zm0 4v-2h14v2zm0 4v-2h14v2zM4 9q-.425 0-.712-.288T3 8t.288-.712T4 7t.713.288T5 8t-.288.713T4 9m0 4q-.425 0-.712-.288T3 12t.288-.712T4 11t.713.288T5 12t-.288.713T4 13m0 4q-.425 0-.712-.288T3 16t.288-.712T4 15t.713.288T5 16t-.288.713T4 17"/></svg>',
            modes: {
                LIST_LOOP: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 210.511V264a112.127 112.127 0 0 1-112 112H78.627l44.686-44.687l-22.626-22.626L56 353.373l-4.415 4.414l-33.566 33.567l74.022 83.276l23.918-21.26L75.63 408H352c79.4 0 144-64.6 144-144v-85.489Z"/><path d="M48 256a112.127 112.127 0 0 1 112-112h273.373l-44.686 44.687l22.626 22.626L456 166.627l4.117-4.116l33.864-33.865l-74.022-83.276l-23.918 21.26L436.37 112H160c-79.4 0-144 64.6-144 144v85.787l32-32Z"/></svg>',
                SINGLE_LOOP: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M208 312v32h112v-32h-40V176h-32v24h-32v32h32v80z"/><path d="M464 210.511V264a112.127 112.127 0 0 1-112 112H78.627l44.686-44.687l-22.626-22.626L56 353.373l-4.415 4.414l-33.566 33.567l74.022 83.276l23.918-21.26L75.63 408H352c79.4 0 144-64.6 144-144v-85.489Z"/><path d="M48 256a112.127 112.127 0 0 1 112-112h273.373l-44.686 44.687l22.626 22.626L456 166.627l4.117-4.116l33.864-33.865l-74.022-83.276l-23.918 21.26L436.37 112H160c-79.4 0-144 64.6-144 144v85.787l32-32Z"/></svg>',
                SEQUENTIAL: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 4V2.068a.5.5 0 0 1 .82-.385l4.12 3.433a.5.5 0 0 1-.321.884H2V4zM2 18h20v2H2zm0-7h20v2H2z"/></svg>',
                RANDOM: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 520 472"><path d="M70 365q74 0 118-57q0-4-5-7l-19-38q-13 27-38.5 43.5T70 323H21q-8 0-14.5 6.5T0 344t6.5 14.5T21 365zM442 9q-16-14-30 0q-15 15 0 30l27 28h-83q-73 0-117 57q0 3 4 7l19 38q13-27 38.5-43.5T356 109h83l-27 28q-15 15 0 30q6 6 15 6q7 0 15-6l64-64q13-15 0-30zm0 256q-16-14-30 0q-15 15 0 30l27 28h-83q-30 0-56-16.5T260 263l-23-47l-24-47l-10-19q-18-38-54-60.5T70 67H21q-8 0-14.5 6.5T0 88t6.5 14.5T21 109h49q64 0 96 60l24 47l23 47l11 19q20 38 55.5 60.5T358 365h84l-28 28q-15 15 0 30q6 6 15 6q8 0 15-6l64-64q13-15 0-30z"/></svg>'
            },
            volumeIcons: {
                mute: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19.8 22.6l-3.025-3.025q-.625.4-1.325.688t-1.45.462v-2.05q.35-.125.688-.25t.637-.3L12 14.8V20l-5-5H3V9h3.2L1.4 4.2l1.4-1.4l18.4 18.4zm-.2-5.8l-1.45-1.45q.425-.775.638-1.625t.212-1.75q0-2.35-1.375-4.2T14 5.275v-2.05q3.1.7 5.05 3.138T21 11.975q0 1.325-.363 2.55T19.6 16.8m-3.35-3.35L14 11.2V7.95q1.175.55 1.838 1.65T16.5 12q0 .375-.062.738t-.188.712M12 9.2L9.4 6.6L12 4zm-2 5.95V12.8L8.2 11H5v2h2.85zm-.9-3.25"/></svg>',
                low: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 15V9h4l5-5v16l-5-5zm2-2h2.85L14 15.15v-6.3L11.85 11H9zm2.5-1"/></svg>',
                medium: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 15V9h4l5-5v16l-5-5zm11 1V7.95q1.125.525 1.813 1.625T18.5 12t-.687 2.4T16 16m-4-7.15L9.85 11H7v2h2.85L12 15.15zM9.5 12"/></svg>',
                high: '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 20.725v-2.05q2.25-.65 3.625-2.5t1.375-4.2t-1.375-4.2T14 5.275v-2.05q3.1.7 5.05 3.138T21 11.975t-1.95 5.613T14 20.725M3 15V9h4l5-5v16l-5-5zm11 1V7.95q1.175.55 1.838 1.65T16.5 12q0 1.275-.663 2.363T14 16m-4-7.15L7.85 11H5v2h2.85L10 15.15zM7.5 12"/></svg>'
            }
        };
        
        // 播放器数据管理
        class AudioPlayerData {
            constructor() {
                this.tracks = [];
                this.currentTrackId = null;
                this.playMode = AUDIO_CONFIG.MODES.LIST_LOOP;
                this.state = AUDIO_CONFIG.STATES.STOPPED;
                this.volume = 70;
                this.isMuted = false;
                this.playHistory = [];
                this.currentTime = 0;
                this.duration = 0;
                this.progress = 0;
                this.isExpanded = false;
                this.showPlaylist = false;
                
                this.observers = [];
            }
            
            // 观察者模式，用于数据变化通知
            subscribe(observer) {
                this.observers.push(observer);
            }
            
            notify(changeType, data) {
                this.observers.forEach(observer => observer.update(changeType, data));
            }
            
            // 数据更新方法
            setTracks(tracks) {
                this.tracks = tracks;
                this.notify('tracks', tracks);
            }
            
            setCurrentTrack(trackId) {
                this.currentTrackId = trackId;
                this.notify('currentTrack', trackId);
            }
            
            setState(state) {
                this.state = state;
                this.notify('state', state);
            }
            
            setPlayMode(mode) {
                this.playMode = mode;
                this.notify('playMode', mode);
            }
            
            setVolume(volume) {
                this.volume = Math.max(0, Math.min(100, volume));
                this.notify('volume', this.volume);
            }
            
            setMuted(muted) {
                this.isMuted = muted;
                this.notify('muted', muted);
            }
            
            setProgress(currentTime, duration) {
                this.currentTime = currentTime;
                this.duration = duration;
                this.progress = duration ? (currentTime / duration) * 100 : 0;
                this.notify('progress', { currentTime, duration, progress: this.progress });
            }
            
            setExpanded(expanded) {
                this.isExpanded = expanded;
                if (!expanded) this.showPlaylist = false;
                this.notify('expanded', expanded);
            }
            
            setPlaylistVisible(visible) {
                this.showPlaylist = visible;
                this.notify('playlist', visible);
            }
            
            // 获取器方法
            getCurrentTrack() {
                return this.tracks.find(track => track.id === this.currentTrackId);
            }
            
            getCurrentTrackTitle() {
                const track = this.getCurrentTrack();
                return track ? track.title : '未选择音频';
            }
            
            getPlayModeText() {
                return AUDIO_CONFIG.MODE_TEXT[this.playMode];
            }
            
            getVolumeIcon() {
                if (this.isMuted || this.volume === 0) return IconService.volumeIcons.mute;
                if (this.volume < 30) return IconService.volumeIcons.low;
                if (this.volume < 70) return IconService.volumeIcons.medium;
                return IconService.volumeIcons.high;
            }
        }
        
        // 工具函数
        class PlayerUtils {
            static generateTracksFromFiles(files) {
                return files.map((filename, index) => ({
                    id: `track_${index + 1}`,
                    title: filename.replace(/\.[^/.]+$/, ""),
                    filename: filename,
                    src: `audio/${filename}`,
                    index: index
                }));
            }
            
            static formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }
            
            static getNextTrackId(currentTrackId, tracks, playMode, playHistory) {
                if (!currentTrackId || tracks.length === 0) return null;
                
                const currentTrack = tracks.find(track => track.id === currentTrackId);
                if (!currentTrack) return null;
                
                switch (playMode) {
                    case AUDIO_CONFIG.MODES.SINGLE_LOOP:
                        return currentTrackId;
                    
                    case AUDIO_CONFIG.MODES.LIST_LOOP:
                        const nextIndex = (currentTrack.index + 1) % tracks.length;
                        return tracks[nextIndex].id;
                    
                    case AUDIO_CONFIG.MODES.SEQUENTIAL:
                        if (currentTrack.index < tracks.length - 1) {
                            return tracks[currentTrack.index + 1].id;
                        }
                        return null;
                    
                    case AUDIO_CONFIG.MODES.RANDOM:
                        const unplayedTracks = tracks.filter(track => !playHistory.includes(track.id));
                        if (unplayedTracks.length === 0) {
                            const availableTracks = tracks.filter(track => track.id !== currentTrackId);
                            if (availableTracks.length === 0) return currentTrackId;
                            return availableTracks[Math.floor(Math.random() * availableTracks.length)].id;
                        }
                        return unplayedTracks[Math.floor(Math.random() * unplayedTracks.length)].id;
                    
                    default:
                        return null;
                }
            }
            
            static getPreviousTrackId(currentTrackId, tracks, playMode) {
                if (!currentTrackId || tracks.length === 0) return null;
                
                const currentTrack = tracks.find(track => track.id === currentTrackId);
                if (!currentTrack) return null;
                
                switch (playMode) {
                    case AUDIO_CONFIG.MODES.SINGLE_LOOP:
                        return currentTrackId;
                    
                    case AUDIO_CONFIG.MODES.LIST_LOOP:
                        const prevIndex = (currentTrack.index - 1 + tracks.length) % tracks.length;
                        return tracks[prevIndex].id;
                    
                    case AUDIO_CONFIG.MODES.SEQUENTIAL:
                        if (currentTrack.index > 0) {
                            return tracks[currentTrack.index - 1].id;
                        }
                        return null;
                    
                    case AUDIO_CONFIG.MODES.RANDOM:
                        const otherTracks = tracks.filter(track => track.id !== currentTrackId);
                        if (otherTracks.length === 0) return currentTrackId;
                        return otherTracks[Math.floor(Math.random() * otherTracks.length)].id;
                    
                    default:
                        return null;
                }
            }
        }
        
        // ========== 渲染控制层 (Rendering Layer) ==========
        
        // DOM 元素引用
        class DOMElements {
            constructor() {
                this.audioElement = document.getElementById('audioElement');
                this.playerBall = document.getElementById('playerBall');
                this.ballIcon = document.getElementById('ballIcon');
                this.playerPanel = document.getElementById('playerPanel');
                this.closeBtn = document.getElementById('closeBtn');
                this.trackTitle = document.getElementById('trackTitle');
                this.playModeText = document.getElementById('playModeText');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressBar = document.getElementById('progressBar');
                this.currentTimeDisplay = document.getElementById('currentTimeDisplay');
                this.durationDisplay = document.getElementById('durationDisplay');
                this.prevBtn = document.getElementById('prevBtn');
                this.playBtn = document.getElementById('playBtn');
                this.playBtnIcon = document.getElementById('playBtnIcon');
                this.nextBtn = document.getElementById('nextBtn');
                this.modeBtn = document.getElementById('modeBtn');
                this.volumeBtn = document.getElementById('volumeBtn');
                this.volumeFill = document.getElementById('volumeFill');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.volumeDisplay = document.getElementById('volumeDisplay');
                this.playlistBtn = document.getElementById('playlistBtn');
                this.playlistPopup = document.getElementById('playlistPopup');
                this.playlistContent = document.getElementById('playlistContent');
            }
        }
        
        // 渲染控制器
        class PlayerRenderer {
            constructor(playerData, domElements) {
                this.data = playerData;
                this.dom = domElements;
                
                // 订阅数据变化
                this.data.subscribe(this);
                
                this.initializeIcons();
            }
            
            initializeIcons() {
                this.dom.ballIcon.innerHTML = IconService.play;
                this.dom.playBtnIcon.innerHTML = IconService.play;
                this.dom.prevBtn.innerHTML = IconService.previous;
                this.dom.nextBtn.innerHTML = IconService.next;
                this.dom.modeBtn.innerHTML = IconService.modes[this.data.playMode];
                this.dom.volumeBtn.innerHTML = this.data.getVolumeIcon();
                this.dom.playlistBtn.innerHTML = IconService.list;
            }
            
            // 观察者模式更新方法
            update(changeType, data) {
                switch (changeType) {
                    case 'state':
                        this.updatePlayState();
                        break;
                    case 'currentTrack':
                        this.updateTrackInfo();
                        break;
                    case 'playMode':
                        this.updatePlayMode();
                        break;
                    case 'volume':
                    case 'muted':
                        this.updateVolume();
                        break;
                    case 'progress':
                        this.updateProgress();
                        break;
                    case 'expanded':
                        this.updateExpanded();
                        break;
                    case 'playlist':
                        this.updatePlaylist();
                        break;
                    case 'tracks':
                        this.updatePlaylistContent();
                        break;
                }
            }
            
            updatePlayState() {
                const isPlaying = this.data.state === AUDIO_CONFIG.STATES.PLAYING;
                const icon = isPlaying ? IconService.pause : IconService.play;
                
                this.dom.ballIcon.innerHTML = icon;
                this.dom.playBtnIcon.innerHTML = icon;
            }
            
            updateTrackInfo() {
                this.dom.trackTitle.textContent = this.data.getCurrentTrackTitle();
            }
            
            updatePlayMode() {
                this.dom.modeBtn.innerHTML = IconService.modes[this.data.playMode];
                this.dom.modeBtn.title = this.data.getPlayModeText();
                this.dom.playModeText.textContent = this.data.getPlayModeText();
            }
            
            updateVolume() {
                const displayVolume = this.data.isMuted ? 0 : this.data.volume;
                this.dom.volumeFill.style.width = `${displayVolume}%`;
                this.dom.volumeSlider.value = this.data.volume;
                this.dom.volumeDisplay.textContent = displayVolume;
                this.dom.volumeBtn.innerHTML = this.data.getVolumeIcon();
            }
            
            updateProgress() {
                this.dom.progressBar.style.width = `${this.data.progress}%`;
                this.dom.currentTimeDisplay.textContent = PlayerUtils.formatTime(this.data.currentTime);
                this.dom.durationDisplay.textContent = PlayerUtils.formatTime(this.data.duration);
            }
            
            updateExpanded() {
                if (this.data.isExpanded) {
                    this.dom.playerBall.classList.add('hidden');
                    this.dom.playerPanel.classList.add('show');
                } else {
                    this.dom.playerBall.classList.remove('hidden');
                    this.dom.playerPanel.classList.remove('show');
                }
            }
            
            updatePlaylist() {
                if (this.data.showPlaylist) {
                    this.dom.playlistPopup.classList.add('show');
                    this.dom.playlistBtn.classList.add('active');
                } else {
                    this.dom.playlistPopup.classList.remove('show');
                    this.dom.playlistBtn.classList.remove('active');
                }
            }
            
            updatePlaylistContent() {
                this.dom.playlistContent.innerHTML = '';
                
                this.data.tracks.forEach((track, index) => {
                    const item = document.createElement('div');
                    item.className = 'playlist-item';
                    if (track.id === this.data.currentTrackId) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <span class="playlist-number">${index + 1}</span>
                        <span class="playlist-title">${track.title}</span>
                        ${track.id === this.data.currentTrackId ? '<span class="playlist-playing">♪</span>' : ''}
                    `;
                    
                    item.addEventListener('click', () => {
                        playerController.playTrack(track.id);
                    });
                    
                    this.dom.playlistContent.appendChild(item);
                });
            }
        }
        
        // 播放器控制器
        class AudioPlayerController {
            constructor(playerData, domElements, renderer) {
                this.data = playerData;
                this.dom = domElements;
                this.renderer = renderer;
                
                this.setupEventListeners();
                this.initialize();
            }
            
            initialize() {
                const tracks = PlayerUtils.generateTracksFromFiles(AUDIO_CONFIG.FILES);
                this.data.setTracks(tracks);
                this.data.setVolume(70);
                
                if (tracks.length > 0) {
                    this.loadTrack(tracks[0].id);
                }
            }
            
            setupEventListeners() {
                // 音频元素事件
                this.dom.audioElement.addEventListener('loadeddata', () => this.renderer.update('tracks', null));
                this.dom.audioElement.addEventListener('timeupdate', () => this.updateProgress());
                this.dom.audioElement.addEventListener('ended', () => this.handleTrackEnded());
                this.dom.audioElement.addEventListener('play', () => this.data.setState(AUDIO_CONFIG.STATES.PLAYING));
                this.dom.audioElement.addEventListener('pause', () => this.data.setState(AUDIO_CONFIG.STATES.PAUSED));
                this.dom.audioElement.addEventListener('loadstart', () => this.data.setState(AUDIO_CONFIG.STATES.LOADING));
                
                // UI 控制事件
                this.dom.playerBall.addEventListener('click', () => this.toggleExpanded());
                this.dom.closeBtn.addEventListener('click', () => this.toggleExpanded());
                this.dom.playBtn.addEventListener('click', () => this.togglePlay());
                this.dom.prevBtn.addEventListener('click', () => this.previous());
                this.dom.nextBtn.addEventListener('click', () => this.next());
                this.dom.modeBtn.addEventListener('click', () => this.togglePlayMode());
                this.dom.volumeBtn.addEventListener('click', () => this.toggleMute());
                this.dom.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
                this.dom.playlistBtn.addEventListener('click', () => this.togglePlaylist());
                this.dom.progressContainer.addEventListener('click', (e) => this.seek(e));
                
                // 点击外部关闭播放列表
                document.addEventListener('click', (e) => {
                    if (!this.dom.playlistPopup.contains(e.target) && !this.dom.playlistBtn.contains(e.target)) {
                        this.data.setPlaylistVisible(false);
                    }
                });
            }
            
            // 播放控制方法
            loadTrack(trackId) {
                const track = this.data.tracks.find(track => track.id === trackId);
                if (!track) return false;
                
                this.dom.audioElement.pause();
                this.data.setCurrentTrack(trackId);
                this.dom.audioElement.src = track.src;
                this.dom.audioElement.load();
                return true;
            }
            
            playTrack(trackId) {
                if (this.loadTrack(trackId)) {
                    setTimeout(() => {
                        this.play();
                    }, 100);
                    if (!this.data.playHistory.includes(trackId)) {
                        this.data.playHistory.push(trackId);
                    }
                }
            }
            
            play() {
                if (this.data.currentTrackId) {
                    this.dom.audioElement.play()
                        .then(() => this.data.setState(AUDIO_CONFIG.STATES.PLAYING))
                        .catch(() => this.data.setState(AUDIO_CONFIG.STATES.PAUSED));
                }
            }
            
            pause() {
                this.dom.audioElement.pause();
                this.data.setState(AUDIO_CONFIG.STATES.PAUSED);
            }
            
            togglePlay() {
                if (this.data.state === AUDIO_CONFIG.STATES.PLAYING) {
                    this.pause();
                } else {
                    this.play();
                }
            }
            
            next() {
                const nextId = PlayerUtils.getNextTrackId(
                    this.data.currentTrackId, 
                    this.data.tracks, 
                    this.data.playMode, 
                    this.data.playHistory
                );
                if (nextId) this.playTrack(nextId);
            }
            
            previous() {
                const prevId = PlayerUtils.getPreviousTrackId(
                    this.data.currentTrackId, 
                    this.data.tracks, 
                    this.data.playMode
                );
                if (prevId) this.playTrack(prevId);
            }
            
            setVolume(volume) {
                this.data.setVolume(volume);
                this.dom.audioElement.volume = this.data.volume / 100;
            }
            
            toggleMute() {
                this.data.setMuted(!this.data.isMuted);
                this.dom.audioElement.muted = this.data.isMuted;
            }
            
            togglePlayMode() {
                const modes = Object.values(AUDIO_CONFIG.MODES);
                const currentIndex = modes.indexOf(this.data.playMode);
                const newMode = modes[(currentIndex + 1) % modes.length];
                
                this.data.setPlayMode(newMode);
                
                if (newMode === AUDIO_CONFIG.MODES.RANDOM) {
                    this.data.playHistory = this.data.currentTrackId ? [this.data.currentTrackId] : [];
                }
            }
            
            toggleExpanded() {
                this.data.setExpanded(!this.data.isExpanded);
            }
            
            togglePlaylist() {
                this.data.setPlaylistVisible(!this.data.showPlaylist);
            }
            
            seek(event) {
                const container = event.currentTarget;
                const clickPosition = (event.clientX - container.getBoundingClientRect().left) / container.offsetWidth;
                this.dom.audioElement.currentTime = clickPosition * this.dom.audioElement.duration;
            }
            
            updateProgress() {
                const audioEl = this.dom.audioElement;
                if (audioEl.duration) {
                    this.data.setProgress(audioEl.currentTime, audioEl.duration);
                }
            }
            
            handleTrackEnded() {
                const nextId = PlayerUtils.getNextTrackId(
                    this.data.currentTrackId, 
                    this.data.tracks, 
                    this.data.playMode, 
                    this.data.playHistory
                );
                if (nextId) {
                    this.playTrack(nextId);
                } else {
                    this.data.setState(AUDIO_CONFIG.STATES.STOPPED);
                }
            }
        }
        
        // ========== 应用初始化 ==========
        
        // 全局变量用于模块间通信
        let playerData, domElements, playerRenderer, playerController;
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            playerData = new AudioPlayerData();
            domElements = new DOMElements();
            playerRenderer = new PlayerRenderer(playerData, domElements);
            playerController = new AudioPlayerController(playerData, domElements, playerRenderer);
        });
    </script>
</body>
</html>
