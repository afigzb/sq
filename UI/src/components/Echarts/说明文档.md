# EChartFactory2 图表工厂系统 - 开发文档

## 一、开发背景：为什么要重新设计图表工厂？

### 1.1 问题的发现

在实际项目开发中，我们发现使用原生 ECharts 存在几个痛点：

```javascript
// 原生 ECharts 的痛点示例
const option = {
  color: ['#5470c6', '#91cc75', '#fac858', '#ee6666'],
  backgroundColor: '#ffffff',
  xAxis: {
    type: 'category',
    data: ['A', 'B', 'C'],
    axisLine: { lineStyle: { color: '#cccccc' } },
    axisLabel: { color: '#666666' },
    splitLine: { lineStyle: { color: '#cccccc', opacity: 0.4 } }
  },
  yAxis: {
    type: 'value',
    axisLine: { lineStyle: { color: '#cccccc' } },
    axisLabel: { color: '#666666' },
    splitLine: { lineStyle: { color: '#cccccc', opacity: 0.4 } }
  },
  series: [{
    type: 'bar',
    data: [120, 200, 150]
  }],
  tooltip: {
    backgroundColor: '#333333',
    textStyle: { color: '#ffffff' }
  },
  grid: { left: '5%', right: '5%', bottom: '15%', top: '5%' }
};
```

**发现的问题：**
1. **配置重复**：每个图表都要写一遍相同的主题配置（颜色、字体、轴线样式等）
2. **维护困难**：要修改主题时需要改动每个图表配置
3. **类型散乱**：不同图表类型的配置方式差异很大，没有统一的抽象
4. **学习成本高**：新人需要熟悉 ECharts 的完整 API（1000+ 配置项）

### 1.2 设计目标的确定

基于这些问题，我确定了几个设计目标：

1. **简化使用**：从复杂配置到简单数据输入
2. **统一抽象**：所有图表类型都有相同的使用方式
3. **主题系统**：集中管理样式，支持动态切换
4. **易于扩展**：新增图表类型和主题要很简单

## 二、架构设计：分层抽象的思考过程

### 2.1 核心设计思想：分离通用与特定

在分析了大量 ECharts 配置后，我发现可以将配置分为两类：

```javascript
// 通用配置（所有图表都需要）
const universalConfig = {
  color: [],           // 调色板
  backgroundColor: '', // 背景色
  grid: {},           // 网格布局
  tooltip: {},        // 提示框
  legend: {},         // 图例
  toolbox: {}         // 工具箱
};

// 特定配置（每种图表独有）
const specificConfig = {
  xAxis: {},          // X轴（柱状图、折线图需要）
  yAxis: {},          // Y轴（柱状图、折线图需要）
  polar: {},          // 极坐标（极坐标图需要）
  radar: {},          // 雷达图配置
  series: []          // 系列配置（每种图表不同）
};
```

**关键洞察**：如果能自动生成通用配置，只让用户关心数据和特定需求，就能大大简化使用。

### 2.2 配置映射系统的设计

基于这个思想，我设计了配置映射系统：

```javascript
// packages/vite-lit-components/src/components/Echarts/EchartFactory/EchartFactory2.js
const CHART_TYPE_CONFIGS = {
  bar: {
    coordinateSystem: 'cartesian',  // 指定坐标系类型
    series: (data, theme, config) => ({  // 系列配置生成器
      type: 'bar',
      data: data.data,
      itemStyle: { 
        color: data.color || theme.colors.series[0],
        // 根据是否横向显示设置边框圆角
        borderRadius: config.inverse ? [0, 2, 2, 0] : [2, 2, 0, 0]
      },
      stack: config.stack || undefined  // 堆叠配置
    }),
    defaultConfig: { boundaryGap: true }  // 类型默认配置
  }
  // 其他图表类型...
};
```

**设计亮点：**
- 每种图表类型都有独立的配置生成器
- 通过 `coordinateSystem` 字段自动选择坐标系处理逻辑
- `series` 函数接收数据、主题、用户配置，返回 ECharts 系列配置
- 支持图表类型的默认配置

### 2.3 坐标系统抽象

不同图表使用不同的坐标系，我抽象出坐标系统配置生成器：

```javascript
const COORDINATE_SYSTEMS = {
  // 直角坐标系：柱状图、折线图、散点图
  cartesian: (chartData, theme, config) => ({
    xAxis: config.inverse ? 
      { type: 'value', ...getAxisStyle(theme) } :  // 横向图表
      { type: 'category', data: chartData.xAxis, ...getAxisStyle(theme) },
    yAxis: config.inverse ?
      { type: 'category', data: chartData.xAxis, ...getAxisStyle(theme) } :
      { type: 'value', ...getAxisStyle(theme) }
  }),
  
  // 极坐标系：极坐标柱状图、极坐标折线图
  polar: (chartData, theme, config) => ({
    polar: { 
      center: ['50%', '50%'], 
      radius: '70%',
      splitLine: { lineStyle: { color: theme.colors.axisLine, opacity: 0.3 } }
    },
    angleAxis: { type: 'category', data: chartData.angleData, ...getAxisStyle(theme) },
    radiusAxis: { type: 'value', ...getAxisStyle(theme) }
  }),
  
  // 雷达坐标系：雷达图
  radar: (chartData, theme) => ({
    radar: {
      indicator: chartData.indicator || chartData.series?.[0]?.indicator || [],
      axisLine: { lineStyle: { color: theme.colors.axisLine } },
      splitLine: { lineStyle: { color: theme.colors.axisLine, opacity: 0.4 } },
      name: { textStyle: { color: theme.colors.text.secondary } }
    }
  }),
  
  // 无坐标系：饼图等
  none: () => ({ xAxis: { show: false }, yAxis: { show: false }, grid: { show: false } })
};
```

**思考过程：**
1. 我发现柱状图和折线图都用直角坐标系，但饼图不需要坐标系
2. 极坐标图表需要特殊的角度轴和径向轴配置
3. 雷达图有自己的指示器系统
4. 通过映射表，可以根据图表类型自动选择合适的坐标系生成器

## 三、支持的图表类型详解

### 3.1 基础图表类型

#### 柱状图 (bar)
```javascript
const chart = createChart(container, 'bar', 'default');
chart.update({
  xAxis: ['产品A', '产品B', '产品C'],
  series: { data: [120, 200, 150] }
}, {
  stack: 'total',    // 堆叠配置
  inverse: false     // 是否横向显示
});
```

#### 折线图 (line)
```javascript
const chart = createChart(container, 'line', 'futuristic');
chart.update({
  xAxis: ['1月', '2月', '3月', '4月'],
  series: { data: [120, 132, 101, 134] }
}, {
  areaStyle: true,   // 面积图样式
  smooth: true       // 平滑曲线
});
```

#### 散点图 (scatter)
```javascript
const chart = createChart(container, 'scatter', 'minimal');
chart.update({
  series: { 
    data: [[161.2, 51.6], [167.5, 59.0], [159.5, 49.2]] // [x, y] 格式
  }
});
```

#### 饼图 (pie)
```javascript
const chart = createChart(container, 'pie', 'cleanDark');
chart.update({
  series: [{
    data: [
      { value: 1048, name: '搜索引擎' },
      { value: 735, name: '直接访问' },
      { value: 580, name: '邮件营销' }
    ]
  }]
}, {
  roseType: 'area'   // 玫瑰图类型
});
```

#### 雷达图 (radar)
```javascript
const chart = createChart(container, 'radar', 'default');
chart.update({
  indicator: [
    { name: '销售', max: 6500 },
    { name: '管理', max: 16000 },
    { name: '信息技术', max: 30000 }
  ],
  series: [{
    data: [{
      value: [4200, 3000, 20000],
      name: '预算分配'
    }]
  }]
});
```

### 3.2 极坐标图表类型

#### 极坐标柱状图 (polarBar)
```javascript
const chart = createChart(container, 'polarBar', 'futuristic');
chart.update({
  angleData: ['周一', '周二', '周三', '周四', '周五'],
  series: [
    { name: '销售额', data: [1, 2, 3, 4, 5] },
    { name: '访问量', data: [2, 4, 6, 8, 10] }
  ]
});
```

#### 极坐标折线图 (polarLine)
```javascript
const chart = createChart(container, 'polarLine', 'default');
chart.update({
  angleData: ['0°', '45°', '90°', '135°', '180°'],
  series: [{
    name: '数据',
    data: [1, 2, 3, 4, 5]
  }]
});
```

## 四、主题系统：解决样式管理难题

### 4.1 完整的主题系统设计

```javascript
// packages/vite-lit-components/src/components/Echarts/config/themes.js

export const defaultTheme = {
  // 基础颜色系统
  colors: {
    text: { 
      primary: '#333333',    // 主要文字色
      secondary: '#666666',  // 次要文字色  
      inverse: '#FFFFFF'     // 反色文字（用于提示框等）
    },
    background: { 
      tooltip: '#333333',    // 提示框背景
      chart: 'transparent'   // 图表背景
    },
    axisLine: '#CCCCCC',     // 坐标轴线颜色
    series: [                // 系列调色板
      '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de'
    ]
  },
  
  // 组件级配置
  components: {
    axisLabel: { fontSize: 12 },
    tooltip: { 
      textStyle: { fontSize: 14, color: '#FFFFFF' }, 
      padding: [8, 12],
      extraCssText: 'box-shadow: 0 2px 8px rgba(0,0,0,0.15); border-radius: 4px;'
    }
  },
  
  // 布局配置
  grid: {
    left: '5%', right: '5%', bottom: '15%', top: '5%',
    containLabel: true
  }
};
```

### 4.2 四套内置主题详解

#### 1. 默认主题 (default)
- **适用场景**：通用、商务报告
- **特点**：简洁、专业、兼容性好
- **调色板**：蓝、绿、黄、红色系

#### 2. 未来科技主题 (futuristic)
```javascript
export const futuristicTheme = {
  colors: {
    series: [
      // 渐变色支持
      {
        type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
        colorStops: [
          { offset: 0, color: '#3FB1E3' },
          { offset: 1, color: '#6be6c1' }
        ]
      }
      // 更多渐变色...
    ]
  },
  components: {
    tooltip: {
      backgroundColor: 'rgba(255, 255, 255, 0.15)',
      extraCssText: 'border-radius: 12px; backdrop-filter: blur(10px);'
    }
  },
  customStyle: {
    itemBorderRadius: 8,
    shadowBlur: 10,
    useGradient: true,
    animation: { duration: 1500, easing: 'cubicOut' }
  }
};
```
- **适用场景**：科技产品、创新报告、炫酷展示
- **特点**：渐变色、毛玻璃效果、圆角设计
- **技术特性**：backdrop-filter、渐变色对象

#### 3. 简约主题 (minimal)
```javascript
export const minimalTheme = {
  hasToolbox: false,  // 禁用工具箱
  colors: {
    series: ['#c23531', '#2f4554', '#61a0a8']
  },
  customStyle: {
    itemBorderRadius: 0,
    shadowBlur: 0,
    useGradient: false,
    animation: { duration: 500, easing: 'linear' }
  }
};
```
- **适用场景**：学术论文、极简设计
- **特点**：无工具箱、直角设计、快速动画

#### 4. 清爽暗色主题 (cleanDark)
```javascript
export const cleanDarkTheme = {
  colors: {
    background: { chart: '#242424' },
    text: { primary: '#CCCCCC', secondary: '#999999' }
  },
  hasToolbox: false
};
```
- **适用场景**：暗色界面、夜间模式
- **特点**：护眼暗色、高对比度

### 4.3 主题应用的工具函数

```javascript
// 获取主题配置
export function getThemeConfig(themeName = 'default') {
  return themes[themeName] || themes.default;
}

// 合并自定义主题
export function mergeThemeWithCustom(theme, customConfig = {}) {
  const themeConfig = typeof theme === 'string' ? getThemeConfig(theme) : theme;
  return deepMerge({}, themeConfig, customConfig);
}

// 动态注册新主题
export function registerTheme(themeName, themeConfig) {
  if (typeof themeName !== 'string' || !themeConfig) {
    throw new Error('主题名称和配置对象都是必需的');
  }
  themes[themeName] = themeConfig;
}
```

## 五、核心实现：EChartFactory2 类的设计

### 5.1 完整的API列表

```javascript
class EChartFactory2 {
  // 基础生命周期
  constructor(container, chartType = 'bar', theme = 'default') {
    // 基础属性
    this.container = container;
    this.chartType = chartType;
    this.themeName = theme;
    this.theme = this.getTheme(theme);
    
    // 实例管理
    this.chartInstance = null;
    this.resizeObserver = null;
    
    // 状态保存（用于主题切换等场景）
    this.currentData = null;
    this.currentConfig = {};
    this.preset = null;
  }
}
```

### 5.2 配置生成的核心逻辑

```javascript
generateOptions(data, config) {
  // 1. 获取图表类型配置
  const chartConfig = CHART_TYPE_CONFIGS[this.chartType];
  
  // 2. 生成基础配置（所有图表共同）
  const baseOptions = {
    color: this.theme.colors.series,
    backgroundColor: this.theme.colors.background.chart,
    grid: this.theme.grid,
    legend: {
      textStyle: { color: this.theme.colors.text.primary },
      icon: 'circle', itemHeight: 8, left: 'center', top: 'top'
    }
  };
  
  // 3. 生成坐标系配置（根据图表类型）
  const coordSystem = COORDINATE_SYSTEMS[chartConfig.coordinateSystem];
  const coordConfig = coordSystem ? coordSystem(data, this.theme, config) : {};
  
  // 4. 生成系列配置（核心数据展示）
  const series = Array.isArray(data.series) ? 
    // 多系列处理
    data.series.map((s, idx) => {
      const seriesConfig = chartConfig.series(s, this.theme, config);
      const themeColor = s.color || this.theme.colors.series[idx];
      return { 
        name: s.name, 
        ...seriesConfig, 
        itemStyle: { ...seriesConfig.itemStyle, color: themeColor } 
      };
    }) :
    // 单系列处理
    [chartConfig.series(data.series || data, this.theme, config)];
  
  // 5. 生成辅助组件配置
  const tooltipType = ['bar', 'line', 'scatter'].includes(this.chartType) ? 'axis' : 'item';
  const tooltip = getTooltipConfig(this.theme, tooltipType);
  const toolbox = getToolboxConfig(this.theme, config.toolboxType || 'basic');
  const specialConfig = this.getSpecialConfig(chartConfig, config);
  
  // 6. 深度合并所有配置（用户配置优先级最高）
  return deepMerge(baseOptions, coordConfig, { series, tooltip, toolbox }, specialConfig, config);
}
```

### 5.3 特殊配置处理

```javascript
getSpecialConfig(chartConfig, config) {
  const special = {};

  // 处理坐标轴边界配置
  if (chartConfig.defaultConfig.boundaryGap !== undefined) {
    if (special.xAxis) special.xAxis.boundaryGap = chartConfig.defaultConfig.boundaryGap;
    if (special.yAxis) special.yAxis.boundaryGap = chartConfig.defaultConfig.boundaryGap;
  }

  // 饼图图例数据：从数据中提取名称用于图例显示
  if (this.chartType === 'pie' && this.currentData?.series?.[0]?.data) {
    special.legend = {
      data: this.currentData.series[0].data.map(item => item.name)
    };
  }

  // 极坐标图表图例数据：显示多系列的名称
  if (['polarBar', 'polarLine'].includes(this.chartType) && Array.isArray(this.currentData?.series)) {
    special.legend = {
      data: this.currentData.series.map(s => s.name),
      show: true
    };
  }

  return special;
}
```

## 六、预设配置系统

### 6.1 内置预设配置

```javascript
export const presetConfigurations = {
  // 仪表盘预设：适用于监控面板
  dashboard: {
    animation: true,
    grid: { top: '10%', bottom: '10%' },
    legend: { show: false },        // 仪表盘通常不显示图例
    toolbox: toolboxConfigs.basic
  },
  
  // 数据分析预设：适用于详细分析
  analysis: {
    animation: false,               // 分析模式关闭动画提高性能
    grid: { top: '10%', bottom: '10%', left: '10%', right: '10%' },
    legend: { show: true, type: 'scroll' },  // 滚动图例支持多数据
    toolbox: toolboxConfigs.standard
  }
};
```

### 6.2 预设配置使用

```javascript
// 设置预设配置
const chart = createChart(container, 'bar', 'default');
chart.setPreset('dashboard')
     .update(data, { stack: 'total' });

// 预设配置会与用户配置合并，用户配置优先级更高
chart.setPreset('analysis')
     .update(data, { 
       animation: true,  // 会覆盖预设的 animation: false
       toolboxType: 'basic' 
     });
```

## 七、工具箱系统

### 7.1 三种工具箱类型

```javascript
export const toolboxConfigs = {
  // 无工具箱
  none: { show: false, feature: {} },
  
  // 基础工具箱：只有保存图片
  basic: {
    feature: {
      saveAsImage: { title: '保存为图片' }
    }
  },
  
  // 标准工具箱：保存、数据视图、还原
  standard: {
    feature: {
      saveAsImage: { title: '保存为图片' },
      dataView: { title: '数据视图', readOnly: false },
      restore: { title: '还原' }
    }
  }
};
```

### 7.2 工具箱主题集成

```javascript
function getToolboxConfig(theme, type = 'basic') {
  // 如果主题明确禁用工具箱
  if (theme.hasToolbox === false) {
    return { show: false };
  }

  const config = toolboxConfigs[type] || toolboxConfigs.basic;
  
  return {
    show: true,
    right: '10px', top: '10px',
    iconStyle: { borderColor: theme.colors.text.secondary },
    emphasis: { iconStyle: { borderColor: theme.colors.text.primary } },
    ...config
  };
}
```

## 八、高级功能详解

### 8.1 独立样式系统

对于需要完全脱离主题系统的特殊定制需求：

```javascript
function createCyberpunkChart() {
  const chart = createChart(container, 'bar', 'default');
  
  // 完全独立的样式配置
  const independentStyle = {
    backgroundColor: {
      type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
      colorStops: [
        { offset: 0, color: '#0f0f23' },
        { offset: 1, color: '#16213e' }
      ]
    },
    color: ['#00ff41', '#ff0080', '#00d4ff'],
    series: [{
      itemStyle: {
        borderWidth: 2,
        borderColor: '#00ff41',
        shadowColor: '#00ff41',
        shadowBlur: 20
      }
    }],
    grid: {
      backgroundColor: 'rgba(0, 255, 65, 0.1)',
      borderColor: '#00ff41',
      borderWidth: 1
    }
  };
  
  const options = chart.generateIndependentOptions(data, independentStyle);
  chart.setCustomOptions(options);
  
  return chart;
}
```

### 8.2 自动响应式处理

```javascript
setupResize() {
  if (!this.resizeObserver) {
    this.resizeObserver = new ResizeObserver(entries => {
      if (this.chartInstance) {
        // 当容器尺寸变化时，自动调整图表大小
        this.chartInstance.resize();
      }
    });
    // 开始观察容器元素
    this.resizeObserver.observe(this.container);
  }
}
```

### 8.3 链式调用支持

所有修改方法都返回 `this`，支持链式调用：

```javascript
const chart = createChart(container, 'bar', 'futuristic')
  .setPreset('dashboard')
  .update(data, { stack: 'total', inverse: true })
  .setCustomStyle({ 
    colors: { series: ['#ff0000', '#00ff00'] } 
  });

// 动态切换
chart.switchTheme('minimal')
     .switchType('line')
     .update(newData, { areaStyle: true });
```

## 九、使用示例分析：从简单到复杂

### 9.1 基础使用模式

```javascript
// 最简单的使用方式：3行代码创建图表
function createBasicBarChart() {
  const chart = createChart(container, 'bar', 'default');
  chart.update({
    xAxis: ['A', 'B', 'C'],
    series: { data: [120, 200, 150] }
  });
  return chart;
}

// 对比原生ECharts需要的代码（50+行）
function createNativeBarChart() {
  const myChart = echarts.init(container);
  const option = {
    color: ['#5470c6'],
    backgroundColor: 'transparent',
    grid: { left: '5%', right: '5%', bottom: '15%', top: '5%', containLabel: true },
    xAxis: {
      type: 'category',
      data: ['A', 'B', 'C'],
      axisLine: { lineStyle: { color: '#CCCCCC' } },
      axisLabel: { color: '#666666', fontSize: 12 },
      splitLine: { lineStyle: { color: '#CCCCCC', width: 0.5, opacity: 0.4 } }
    },
    yAxis: {
      type: 'value',
      axisLine: { lineStyle: { color: '#CCCCCC' } },
      axisLabel: { color: '#666666', fontSize: 12 },
      splitLine: { lineStyle: { color: '#CCCCCC', width: 0.5, opacity: 0.4 } }
    },
    series: [{ type: 'bar', data: [120, 200, 150] }],
    tooltip: {
      backgroundColor: '#333333',
      textStyle: { color: '#FFFFFF', fontSize: 14 },
      padding: [8, 12],
      extraCssText: 'box-shadow: 0 2px 8px rgba(0,0,0,0.15); border-radius: 4px;'
    },
    legend: { textStyle: { color: '#333333' }, icon: 'circle' }
  };
  myChart.setOption(option);
  return myChart;
}
```

**效果对比**：
- **代码量**：从 50+ 行减少到 3 行（减少 94%）
- **配置复杂度**：从手动配置每个组件到只关心数据
- **维护性**：主题修改只需要切换主题名称

### 9.2 多系列图表示例

```javascript
// 多系列折线图
function createMultiSeriesChart() {
  const chart = createChart(container, 'line', 'futuristic');
  
  chart.update({
    xAxis: ['1月', '2月', '3月', '4月', '5月'],
    series: [
      { 
        name: '销售额', 
        data: [120, 132, 101, 134, 90],
        color: '#3FB1E3'  // 可选：指定系列颜色
      },
      { 
        name: '访问量', 
        data: [220, 182, 191, 234, 290] 
      },
      { 
        name: '下载量', 
        data: [150, 232, 201, 154, 190] 
      }
    ]
  }, {
    areaStyle: true,    // 面积图样式
    smooth: true        // 平滑曲线
  });
  
  return chart;
}
```

### 9.3 高级配置示例

```javascript
// 复杂配置的简化使用
function createAdvancedChart() {
  const chart = createChart(container, 'bar', 'futuristic');
  
  chart
    .setPreset('dashboard')     // 应用仪表盘预设
    .update(data, {
      stack: 'total',           // 堆叠配置
      inverse: true,            // 水平显示
      toolboxType: 'standard'   // 标准工具箱
    })
    .setCustomStyle({          // 自定义样式
      animation: { duration: 2000 },
      colors: { 
        series: ['#ff6b6b', '#4ecdc4', '#45b7d1'] 
      }
    });
    
  return chart;
}
```

### 9.4 批量创建的实际应用

```javascript
function createDashboard() {
  // 一次性创建多个不同类型、不同主题的图表
  const charts = createCharts([
    {
      container: document.getElementById('chart1'),
      chartType: 'bar', 
      theme: 'default',
      data: {
        xAxis: ['产品A', '产品B', '产品C'],
        series: { data: [120, 200, 150] }
      }, 
      customConfig: { stack: 'total' }
    },
    {
      container: document.getElementById('chart2'),
      chartType: 'line', 
      theme: 'minimal',
      data: {
        xAxis: ['1月', '2月', '3月'],
        series: { data: [65, 59, 80] }
      }, 
      customConfig: { areaStyle: true }
    },
    {
      container: document.getElementById('chart3'),
      chartType: 'pie', 
      theme: 'cleanDark',
      data: {
        series: [{
          data: [
            { value: 1048, name: '搜索引擎' },
            { value: 735, name: '直接访问' }
          ]
        }]
      }, 
      customConfig: { roseType: 'area' }
    },
    {
      container: document.getElementById('chart4'),
      chartType: 'polarBar', 
      theme: 'futuristic',
      data: {
        angleData: ['周一', '周二', '周三', '周四', '周五'],
        series: [
          { name: '销售额', data: [1, 2, 3, 4, 5] },
          { name: '访问量', data: [2, 4, 6, 8, 10] }
        ]
      },
      customConfig: {}
    }
  ]);
  
  return charts;
}
```

### 9.5 实时数据更新示例

```javascript
function createRealtimeChart() {
  const chart = createChart(container, 'line', 'futuristic');
  
  // 初始数据
  let timeData = [];
  let valueData = [];
  
  function updateData() {
    const now = new Date();
    timeData.push(now.toLocaleTimeString());
    valueData.push(Math.random() * 100);
    
    // 保持最新的20个数据点
    if (timeData.length > 20) {
      timeData.shift();
      valueData.shift();
    }
    
    // 更新图表 - 只需要关心数据，样式由主题管理
    chart.update({
      xAxis: timeData,
      series: { data: valueData }
    }, {
      areaStyle: true,
      smooth: true
    });
  }
  
  // 每秒更新一次
  setInterval(updateData, 1000);
  
  return chart;
}
```

### 9.6 主题动态切换示例

```javascript
function createThemeSwitcher() {
  const chart = createChart(container, 'bar', 'default');
  const data = {
    xAxis: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
    series: { data: [120, 200, 150, 80, 70] }
  };
  
  chart.update(data);
  
  // 创建主题切换按钮
  document.getElementById('theme-default').onclick = () => {
    chart.switchTheme('default');
  };
  
  document.getElementById('theme-futuristic').onclick = () => {
    chart.switchTheme('futuristic');
  };
  
  document.getElementById('theme-minimal').onclick = () => {
    chart.switchTheme('minimal');
  };
  
  document.getElementById('theme-cleanDark').onclick = () => {
    chart.switchTheme('cleanDark');
  };
  
  return chart;
}
```

### 9.7 图表类型动态切换示例

```javascript
function createTypeSwitcher() {
  const chart = createChart(container, 'bar', 'futuristic');
  const data = {
    xAxis: ['苹果', '香蕉', '橙子', '葡萄'],
    series: { data: [10, 20, 15, 25] }
  };
  
  chart.update(data);
  
  // 类型切换按钮
  document.getElementById('type-bar').onclick = () => {
    chart.switchType('bar');
  };
  
  document.getElementById('type-line').onclick = () => {
    chart.switchType('line').update(data, { areaStyle: true });
  };
  
  document.getElementById('type-pie').onclick = () => {
    // 饼图需要不同的数据格式
    chart.switchType('pie').update({
      series: [{
        data: [
          { value: 10, name: '苹果' },
          { value: 20, name: '香蕉' },
          { value: 15, name: '橙子' },
          { value: 25, name: '葡萄' }
        ]
      }]
    });
  };
  
  return chart;
}
```

## 十、扩展性设计：如何添加新功能

### 10.1 添加新图表类型

```javascript
// 1. 在 CHART_TYPE_CONFIGS 中添加配置
CHART_TYPE_CONFIGS.heatmap = {
  coordinateSystem: 'cartesian',
  series: (data, theme, config) => ({
    type: 'heatmap',
    data: data.data,  // 热力图数据格式：[[x, y, value], ...]
    itemStyle: {
      color: data.color || theme.colors.series[0]
    },
    label: {
      show: config.showLabel || false,
      color: theme.colors.text.primary
    }
  }),
  defaultConfig: { boundaryGap: true }
};

// 2. 如果需要特殊坐标系，添加到 COORDINATE_SYSTEMS
// 热力图使用直角坐标系，所以不需要额外配置

// 3. 使用新图表类型
const heatmapChart = createChart(container, 'heatmap', 'default');
heatmapChart.update({
  xAxis: ['12a', '1a', '2a', '3a', '4a'],
  yAxis: ['Monday', 'Tuesday', 'Wednesday'],
  series: {
    data: [[0, 0, 5], [0, 1, 1], [0, 2, 0]]  // [x索引, y索引, 值]
  }
}, {
  showLabel: true
});
```

### 10.2 添加新主题

```javascript
// 1. 定义主题配置
const neonTheme = {
  colors: {
    text: { primary: '#00ff41', secondary: '#008f11', inverse: '#000000' },
    background: { tooltip: 'rgba(0, 255, 65, 0.9)', chart: '#000000' },
    axisLine: '#00ff41',
    series: [
      '#00ff41',  // 霓虹绿
      '#ff0080',  // 霓虹粉
      '#8000ff',  // 霓虹紫
      '#00d4ff',  // 霓虹蓝
      '#ffff00'   // 霓虹黄
    ]
  },
  components: {
    axisLabel: { 
      fontSize: 12, 
      color: '#00ff41',
      fontFamily: 'monospace'
    },
    tooltip: { 
      textStyle: { fontSize: 14, color: '#000000', fontWeight: 'bold' }, 
      padding: [10, 15],
      extraCssText: 'border-radius: 0; border: 2px solid #00ff41; box-shadow: 0 0 20px #00ff41;'
    }
  },
  grid: {
    left: '5%', right: '5%', bottom: '15%', top: '5%',
    backgroundColor: 'rgba(0, 255, 65, 0.05)',
    borderColor: '#00ff41',
    borderWidth: 1
  },
  customStyle: {
    itemBorderRadius: 0,
    shadowColor: '#00ff41',
    shadowBlur: 15,
    useGradient: false,
    animation: { duration: 1000, easing: 'elasticOut' }
  }
};

// 2. 注册主题
registerTheme('neon', neonTheme);

// 3. 使用新主题
const chart = createChart(container, 'bar', 'neon');
chart.update(data);
```

### 10.3 添加新的预设配置

```javascript
// 1. 添加新的预设配置
presetConfigurations.presentation = {
  animation: true,
  animationDuration: 3000,           // 演示模式使用较长动画
  grid: { 
    top: '15%', 
    bottom: '15%', 
    left: '8%', 
    right: '8%' 
  },
  legend: { 
    show: true, 
    top: 'top',
    itemGap: 30,                     // 图例间距大一些
    textStyle: { fontSize: 16 }      // 演示模式字体大一些
  },
  toolbox: toolboxConfigs.standard
};

// 2. 添加移动端预设
presetConfigurations.mobile = {
  animation: false,                  // 移动端关闭动画提高性能
  grid: { 
    top: '5%', 
    bottom: '5%', 
    left: '2%', 
    right: '2%',
    containLabel: true 
  },
  legend: { 
    show: false                      // 移动端通常不显示图例节省空间
  },
  toolbox: toolboxConfigs.none,      // 移动端不显示工具箱
  tooltip: {
    trigger: 'axis',
    axisPointer: { type: 'shadow' }  // 移动端使用阴影指示器
  }
};

// 3. 使用预设
const chart = createChart(container, 'bar', 'default');
chart.setPreset('presentation')
     .update(data, { stack: 'total' });
```

### 10.4 添加新的工具箱配置

```javascript
// 1. 添加高级工具箱配置
toolboxConfigs.advanced = {
  feature: {
    saveAsImage: { 
      title: '保存为图片',
      pixelRatio: 2  // 高清图片
    },
    dataView: { 
      title: '数据视图', 
      readOnly: false,
      lang: ['数据视图', '关闭', '刷新']
    },
    restore: { title: '还原' },
    dataZoom: { 
      title: { zoom: '区域缩放', back: '区域缩放还原' }
    },
    magicType: {
      title: { line: '切换为折线图', bar: '切换为柱状图' },
      type: ['line', 'bar']
    }
  }
};

// 2. 添加简化工具箱（只有必要功能）
toolboxConfigs.essential = {
  feature: {
    saveAsImage: { title: '保存图片' },
    restore: { title: '重置' }
  }
};

// 3. 在图表中使用
const chart = createChart(container, 'bar', 'default');
chart.update(data, { toolboxType: 'advanced' });
```

### 10.5 扩展坐标系统

```javascript
// 添加新的坐标系统：3D坐标系
COORDINATE_SYSTEMS.cartesian3D = (chartData, theme, config) => ({
  // 3D网格配置
  grid3D: {
    boxWidth: 100,
    boxHeight: 100,
    boxDepth: 100,
    light: {
      main: {
        intensity: 1.2,
        shadow: true
      }
    },
    viewControl: {
      autoRotate: config.autoRotate || false
    }
  },
  // 3D坐标轴
  xAxis3D: {
    type: 'category',
    data: chartData.xAxis,
    axisLine: { lineStyle: { color: theme.colors.axisLine } }
  },
  yAxis3D: {
    type: 'category', 
    data: chartData.yAxis,
    axisLine: { lineStyle: { color: theme.colors.axisLine } }
  },
  zAxis3D: {
    type: 'value',
    axisLine: { lineStyle: { color: theme.colors.axisLine } }
  },
  // 隐藏2D坐标轴
  xAxis: { show: false },
  yAxis: { show: false },
  grid: { show: false }
});

// 添加3D柱状图类型
CHART_TYPE_CONFIGS.bar3D = {
  coordinateSystem: 'cartesian3D',
  series: (data, theme, config) => ({
    type: 'bar3D',
    data: data.data,  // 3D数据格式：[[x, y, z], ...]
    itemStyle: {
      color: data.color || theme.colors.series[0],
      opacity: 0.8
    },
    shading: 'lambert'
  }),
  defaultConfig: {}
};
```

## 十一、性能优化和最佳实践

### 11.1 内存管理

```javascript
// 完整的资源清理
dispose() {
  // 停止尺寸观察
  if (this.resizeObserver) {
    this.resizeObserver.disconnect();
    this.resizeObserver = null;
  }
  
  // 销毁 ECharts 实例
  if (this.chartInstance) {
    this.chartInstance.dispose();
    this.chartInstance = null;
  }
  
  // 清理状态数据
  this.currentData = null;
  this.currentConfig = null;
  this.theme = null;
  
  return this;
}

// 批量销毁图表
function disposeCharts(charts) {
  charts.forEach(chart => {
    if (chart && typeof chart.dispose === 'function') {
      chart.dispose();
    }
  });
}
```

### 11.2 响应式处理

```javascript
// 自动尺寸适应的完整实现
setupResize() {
  if (!this.resizeObserver) {
    // 防抖处理，避免频繁触发resize
    let resizeTimer = null;
    
    this.resizeObserver = new ResizeObserver(entries => {
      if (this.chartInstance) {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          this.chartInstance.resize();
        }, 100);  // 100ms防抖
      }
    });
    
    this.resizeObserver.observe(this.container);
  }
}

// 手动触发重绘
resize() {
  if (this.chartInstance) {
    this.chartInstance.resize();
  }
  return this;
}
```

### 11.3 配置缓存策略

```javascript
class EChartFactory2 {
  constructor(container, chartType, theme) {
    // ... 其他代码
    
    // 添加配置缓存
    this.configCache = new Map();
    this.optionsCache = new Map();
  }
  
  generateOptions(data, config) {
    // 创建缓存键
    const cacheKey = JSON.stringify({ 
      chartType: this.chartType, 
      themeName: this.themeName, 
      config 
    });
    
    // 检查缓存
    if (this.optionsCache.has(cacheKey)) {
      const cachedOptions = this.optionsCache.get(cacheKey);
      // 只更新数据部分
      return { ...cachedOptions, series: this.generateSeries(data, config) };
    }
    
    // 生成完整配置
    const options = this.doGenerateOptions(data, config);
    
    // 缓存配置（数据部分除外）
    this.optionsCache.set(cacheKey, options);
    
    return options;
  }
}
```

### 11.4 大数据量优化

```javascript
// 大数据量图表的优化配置
function createLargeDataChart(container, data) {
  const chart = createChart(container, 'line', 'minimal');
  
  // 针对大数据量的优化配置
  const optimizedConfig = {
    animation: false,           // 关闭动画提高性能
    progressive: 400,           // 渐进式渲染阈值
    progressiveThreshold: 3000, // 数据量超过3000时启用渐进式渲染
    useUTC: true,              // 使用UTC时间提高时间序列性能
    
    // 简化样式减少渲染负担
    itemStyle: {
      borderWidth: 0
    },
    lineStyle: {
      width: 1
    },
    symbol: 'none',            // 不显示数据点符号
    
    // 优化坐标轴
    xAxis: {
      splitNumber: 5           // 减少坐标轴刻度数量
    },
    yAxis: {
      splitNumber: 5
    }
  };
  
  chart.update(data, optimizedConfig);
  return chart;
}
```

### 11.5 最佳实践建议

#### 1. 图表创建最佳实践
```javascript
// ✅ 推荐：使用工厂函数
const chart = createChart(container, 'bar', 'default');

// ❌ 不推荐：直接使用类构造函数
const chart = new EChartFactory2(container, 'bar', 'default');
chart.init();  // 容易忘记初始化
```

#### 2. 数据更新最佳实践
```javascript
// ✅ 推荐：使用相同的数据结构
chart.update({
  xAxis: ['A', 'B', 'C'],
  series: { data: [1, 2, 3] }
});

// ❌ 不推荐：频繁改变数据结构
chart.update({ series: [{ data: [1, 2, 3] }] });  // 有时用数组
chart.update({ series: { data: [4, 5, 6] } });    // 有时用对象
```

#### 3. 主题使用最佳实践
```javascript
// ✅ 推荐：根据场景选择合适的主题
const dashboardChart = createChart(container, 'bar', 'minimal');     // 仪表盘
const presentationChart = createChart(container, 'line', 'futuristic'); // 演示
const reportChart = createChart(container, 'pie', 'default');        // 报告

// ✅ 推荐：统一管理主题
const themeConfig = {
  dashboard: 'minimal',
  presentation: 'futuristic', 
  report: 'default',
  darkMode: 'cleanDark'
};
```

#### 4. 性能优化最佳实践
```javascript
// ✅ 推荐：及时销毁不用的图表
function cleanup() {
  charts.forEach(chart => chart.dispose());
  charts = [];
}

// ✅ 推荐：大数据量时禁用动画
const config = data.length > 1000 ? { animation: false } : {};
chart.update(data, config);

// ✅ 推荐：使用防抖处理频繁更新
let updateTimer = null;
function scheduleUpdate(data) {
  clearTimeout(updateTimer);
  updateTimer = setTimeout(() => {
    chart.update(data);
  }, 100);
}
```

## 十二、开发总结：设计思想的回顾

### 12.1 核心设计原则

1. **分离关注点**：通用配置 vs 特定配置，样式 vs 数据，结构 vs 行为
2. **配置优先级**：用户配置 > 预设配置 > 主题配置 > 默认配置
3. **一致性接口**：所有图表类型都使用相同的 API
4. **渐进增强**：从简单使用到复杂定制都有对应的 API

### 12.2 解决的核心问题

1. **配置复杂度**：从 50+ 行配置到 3 行调用（减少 94%）
2. **主题管理**：集中式主题系统，支持动态切换
3. **类型抽象**：统一的图表创建和更新接口
4. **维护性**：新增功能只需要在配置映射中添加

### 12.3 架构优势

```javascript
// 从这样的复杂配置...
const complexOption = {
  // 50+ 行的 ECharts 原生配置...
  color: ['#5470c6', '#91cc75'],
  backgroundColor: 'transparent',
  grid: { left: '5%', right: '5%', bottom: '15%', top: '5%', containLabel: true },
  xAxis: {
    type: 'category',
    data: ['A', 'B', 'C'],
    axisLine: { lineStyle: { color: '#CCCCCC' } },
    axisLabel: { color: '#666666', fontSize: 12 },
    splitLine: { lineStyle: { color: '#CCCCCC', width: 0.5, opacity: 0.4 } }
  },
  yAxis: {
    type: 'value',
    axisLine: { lineStyle: { color: '#CCCCCC' } },
    axisLabel: { color: '#666666', fontSize: 12 },
    splitLine: { lineStyle: { color: '#CCCCCC', width: 0.5, opacity: 0.4 } }
  },
  series: [{ type: 'bar', data: [120, 200, 150] }],
  tooltip: {
    backgroundColor: '#333333',
    textStyle: { color: '#FFFFFF', fontSize: 14 },
    padding: [8, 12]
  },
  legend: { textStyle: { color: '#333333' }, icon: 'circle' }
};

// 到这样的简单调用...
const chart = createChart(container, 'bar', 'futuristic')
  .setPreset('dashboard')
  .update({
    xAxis: ['A', 'B', 'C'],
    series: { data: [120, 200, 150] }
  }, { 
    stack: 'total',
    inverse: true 
  });
```

### 12.4 设计成果

这个设计让图表的创建和管理变得：
- **更简单**：减少 90% 的配置代码
- **更统一**：所有图表都用相同方式创建
- **更灵活**：支持从简单到复杂的各种需求
- **更易维护**：修改主题或添加功能都很方便
- **更易扩展**：新增图表类型只需要添加配置映射
- **更高性能**：内置响应式处理和性能优化

通过这套系统，开发者可以专注于数据和业务逻辑，而不用花大量时间在图表配置上。这正是一个好的工具库应该达到的效果：**简化复杂度，提高生产力**。

### 12.5 与原生 ECharts 对比

| 对比项 | 原生 ECharts | EChartFactory2 | 优势 |
|--------|-------------|----------------|------|
| 配置复杂度 | 50+ 行配置 | 3 行调用 | 减少 94% |
| 学习成本 | 1000+ 配置项 | 10+ 方法 | 大幅降低 |
| 主题管理 | 手动配置每个图表 | 一键切换 | 集中管理 |
| 类型统一 | 每种图表不同API | 统一接口 | 易于使用 |
| 代码维护 | 分散在各处 | 集中管理 | 易于维护 |
| 功能扩展 | 需要深度定制 | 配置映射 | 易于扩展 |

这个图表工厂系统成功地将 ECharts 的强大功能包装在了简洁易用的接口之下，让图表开发变得更加高效和愉悦。
