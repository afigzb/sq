<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OriginalEditionDatepicker_PC_3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50/30 p-8">
  <div class="sm:fixed absolute top-12 sm:top-4 left-0 z-10" x-data="createCalendar()" class="w-64">
    <div class="flex space-x-4 p-4 w-80" x-data="{modeDrawerOpen: false,calendarDrawerOpen: false}" @click.away="calendarDrawerOpen = false">
    <!-- 抽屉一：视图模式选择 -->
    <div  class="mb-4 absolute"
    @click.away="modeDrawerOpen = false">
    <!-- 当前模式显示 -->
    <div @click="modeDrawerOpen = !modeDrawerOpen;calendarDrawerOpen=false" 
        class="flex relative items-center cursor-pointer bg-gray-600 p-2 rounded-lg shadow-sm hover:shadow-md transition-shadow w-32">
        <!-- <span class="text-xs font-semibold text-gray-300">视图：</span> -->
        <span x-text="viewMode === 'day' ? '按天' : viewMode === 'week' ? '按周' : viewMode === 'month' ? '按月' : '按年'" 
            class="ml-2 text-white font-medium"></span>
        <svg :class="modeDrawerOpen ? 'rotate-180' : ''" 
            class="w-4 h-4 ml-2 text-gray-400 absolute right-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </div>

    <!-- 模式选择面板 -->
    <div x-show="modeDrawerOpen" x-collapse
        class="mt-1 bg-gray-600 p-2 rounded-lg border border-gray-600/50 shadow-inner">
        <div class="flex flex-col gap-1">
        <template x-for="mode in ['day', 'week', 'month', 'year']">
            <button @click="switchView(mode); calendarDrawerOpen=true;modeDrawerOpen=false" 
                    :class="{
                    'bg-blue-600 text-white': viewMode === mode,
                    'text-gray-300 hover:bg-gray-600': viewMode !== mode
                    }"
                    class="px-3 py-1.5 rounded-md font-medium transition-all duration-200 hover:scale-105 active:scale-95">
            <span x-text="mode === 'day' ? '按天' : mode === 'week' ? '按周' : mode === 'month' ? '按月' : '按年'"></span>
            </button>
        </template>
        </div>
    </div>
    </div>
    <!-- 抽屉二：时间选择 -->
    <div class="absolute translate-x-36" 
    >
    <!-- 时间显示头部 -->
    <div @click="calendarDrawerOpen = !calendarDrawerOpen" 
        class="flex relative pr-8 items-center cursor-pointer bg-gray-600 p-2 rounded-lg shadow-sm hover:shadow-md transition-shadow"
        x-show="selectedDate">
        <svg class="w-4 h-4 mr-2 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <span x-show="viewMode === 'day'" class="text-white font-medium" 
            x-text="`${formatDate(selectedDate,viewMode)}`"></span>
        <span x-show="viewMode === 'week'" class="text-white font-medium" 
            x-text="`${ '（第'+getWeekNumber(selectedDate)+'周）'}`"></span>
        <span x-show="viewMode === 'month'" class="text-white font-medium" 
            x-text="`${formatDate(selectedDate,'year')}年 ${formatDate(selectedDate,viewMode)}月`"></span>
        <span x-show="viewMode === 'year'" class="text-white font-medium" 
            x-text="`${formatDate(selectedDate,viewMode)}年`"></span>
        <svg :class="calendarDrawerOpen ? 'rotate-180' : ''" 
            class="w-4 h-4 ml-2 text-gray-400 transition-transform absolute right-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </div>

    <!-- 日历主体 -->
    <div x-show="calendarDrawerOpen" x-collapse class="absolute -left-36 sm:-right-0 sm:-left-0 mt-2 min-w-96">
        <div class="max-w-[92vw] bg-gray-600 rounded-xl shadow-xl shadow-gray-900/40 p-4">
        <!-- 控制栏 -->
        <div class="flex justify-between items-center mb-4 gap-4">
            <button @click="navigate(-1)" class="p-2 hover:bg-gray-600 rounded-lg text-blue-400 hover:text-blue-300 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 19l-7-7 7-7"/>
            </svg>
            </button>
            <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-400">
              <template x-if="viewMode === 'year'">
                  <span x-text="`${calendarData.years[0].year}年 – ${calendarData.years[calendarData.years.length - 1].year}年`"></span>
              </template>
              <template x-if="viewMode === 'month'">
                  <span x-text="`${formatDate(currentTimestamp, 'year')}年`"></span>
              </template>
              <template x-if="['day', 'week'].includes(viewMode)">
                  <span x-text="`${currentDate().getFullYear()}年 ${formatDate(currentTimestamp, 'month')}月`"></span>
              </template>
            </h2>
            <button @click="navigate(1)" class="p-2 hover:bg-gray-600 rounded-lg text-blue-400 hover:text-blue-300 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9 5l7 7-7 7"/>
            </svg>
            </button>
        </div>
    
        <!-- 日/周视图 -->
        <template x-if="['day', 'week'].includes(viewMode)">
            <div class="grid grid-cols-7 gap-2">
            <template x-for="day in calendarData.days" :key="day.timestamp">
                <button @click="selectDate(day.timestamp);calendarDrawerOpen=false;selectedData()"
                        :class="{
                        'text-gray-400': !day.isCurrentMonth,
                        'bg-blue-500 text-white': day.isSelected,
                        'ring-2 ring-blue-500/30': viewMode === 'week' && day.isInWeek,
                        'hover:bg-blue-500 text-white ': day.isCurrentMonth && !day.isSelected,
                        'font-semibold text-white relative': day.isToday
                        }"
                        class="h-14 flex flex-col items-center justify-center rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105">
                <span x-text="day.date" class=" font-medium"></span>
                <span class="text-xs uppercase mt-0.5"
                        :class="{'text-gray-400': !day.isSelected, 'text-white/80': day.isSelected}">
                    <span x-text="new Date(day.timestamp).toLocaleDateString('zh-CN', { weekday: 'short' })"></span>
                </span>
                <template x-if="day.isToday">
                    <div class="absolute top-1 right-1 w-2 h-2 bg-blue-500 rounded-full"></div>
                </template>
                </button>
            </template>
            </div>
        </template>

        <!-- 月视图 -->
        <template x-if="viewMode === 'month'">
            <div class="grid grid-cols-4 gap-4">
            <template x-for="(month, index) in calendarData.months" :key="index">
                <button @click="
                currentTimestamp = month.timestamp; 
                selectedDate = new Date(new Date(currentTimestamp).getFullYear(), new Date(month.timestamp).getMonth(), 1).getTime();
                calendarDrawerOpen=false;
                selectedData()
                "
                    :class="{
                    'bg-gradient-to-tl from-blue-400 via-blue-500 to-blue-600 text-white': month.isSelected,
                    'text-gray-600 hover:bg-blue-500': !month.isSelected
                    }"
                    class="p-3 rounded-lg transition-all ease-in-out transform hover:scale-105  font-semibold">
                <span class="text-white" x-text="month.name"></span>
                </button>
            </template>
            </div>
        </template>

        <!-- 年视图 -->
        <template x-if="viewMode === 'year'">
            <div class="grid grid-cols-5 gap-4">
            <template x-for="yearData in calendarData.years" :key="yearData.year">
                <button @click="currentTimestamp = new Date(currentTimestamp).setFullYear(yearData.year);
                selectedDate = new Date(selectedDate).setFullYear(yearData.year);
                calendarDrawerOpen=false;
                selectedData()"
                        :class="{
                        'bg-blue-500 text-white': yearData.isSelected,
                        'text-gray-600 hover:bg-blue-500': !yearData.isSelected
                        }"
                        class="p-3 rounded-lg transition-all ease-in-out transform hover:scale-105 font-semibold">
                <span class="text-white" x-text="yearData.year"></span>
                <span x-show="yearData.year === new Date().getFullYear()"
                        class="block w-4 h-0.5 bg-blue-400 mt-1 mx-auto rounded-full"></span>
                </button>
            </template>
            </div>
        </template>

        </div>
    </div>
    </div>
</div>
  </div>
</body>
<script>

function createCalendar(config = {}) {
  return {
    currentTimestamp: new Date().setHours(0, 0, 0, 0),
    viewMode: 'month',
    selectedDate: new Date().setHours(0, 0, 0, 0),
    selectedWeek: null,

    init() {
      this.updateSelectedWeek(new Date(this.selectedDate));
      // 日期保留逻辑，不需要则注释
        // this.$watch('currentTimestamp', (newVal) => {
        //     if (!this.selectedDate) return;
            
        //     const oldDate = new Date(this.selectedDate);
        //     const newBaseDate = new Date(newVal);
            
        //     // 保持原有日期天数，调整年月
        //     const testDate = new Date(
        //         newBaseDate.getFullYear(),
        //         newBaseDate.getMonth(),
        //         oldDate.getDate()
        //     );

        //     // 处理无效日期
        //     if (testDate.getMonth() !== newBaseDate.getMonth()) {
        //         testDate.setDate(0); // 设置为上月最后一天
        //     }

        //     this.selectedDate = testDate.getTime();
        //     this.updateSelectedWeek(testDate); // 确保周范围同步更新
        // });
    },

    // 获取当前日期对象
    currentDate() {
      return new Date(this.currentTimestamp)
    },

    // 获取日历数据
    get calendarData() {
      return {
        years: this.generateYears(),
        months: this.generateMonths(),
        days: this.generateDays(),
        weekDays: this.generateWeekDays()
      }
    },

    // 生成年
    generateYears() {
      const currentYear = this.currentDate().getFullYear(); // 基于当前视图的年份
      const selectedYear = new Date(this.selectedDate).getFullYear();
      
      // 以当前视图年份所在的20年块为范围
      const startYear = Math.floor(currentYear / 20) * 20; 
      
      return Array.from({ length: 20 }, (_, i) => {
        const year = startYear + i;
        return {
          year: year,
          isSelected: year === selectedYear
        };
      });
    },

    // 生成月
    generateMonths() {
      const currentYear = this.currentDate().getFullYear()
      const selectedYear = new Date(this.selectedDate).getFullYear()
      const selectedMonth = new Date(this.selectedDate).getMonth()
      
      return Array.from({ length: 12 }, (_, i) => ({
        name: new Date(currentYear, i, 1).toLocaleString('default', { month: 'short' }),
        timestamp: new Date(currentYear, i, 1).getTime(),
        isSelected: currentYear === selectedYear && i === selectedMonth
      }))
    },
    // 生成日
    generateDays() {
      const date = new Date(this.currentTimestamp)
      const baseDate = new Date(date.getFullYear(), date.getMonth(), 1)
      const startDayOffset = baseDate.getDay() === 0 ? 6 : baseDate.getDay() - 1
      const startDate = new Date(baseDate)
      startDate.setDate(-startDayOffset + 1)

      return Array.from({ length: 42 }, (_, i) => {
        const dayDate = new Date(startDate)
        dayDate.setDate(startDate.getDate() + i)
        
        return {
          date: dayDate.getDate(),
          timestamp: dayDate.getTime(),
          isCurrentMonth: dayDate.getMonth() === date.getMonth(),
          ...this.getDayStates(dayDate) // 合并日期状态
        }
      })
    },
    // 生成周
    generateWeekDays() {
      const date = new Date(this.selectedDate || this.currentTimestamp)
      const diff = date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)
      
      return Array.from({ length: 7 }, (_, i) => {
        const d = new Date(date.setDate(diff + i))
        return {
          date: d.getDate(),
          timestamp: d.getTime(),
          isCurrentMonth: d.getMonth() === this.currentDate().getMonth()
        }
      })
    },

    // 判断日期状态
    getDayStates(dayDate) {
      const isSameMonth = dayDate.getMonth() === this.currentDate().getMonth()
      const isSelected = this.selectedDate === dayDate.getTime()
      const isInWeek = this.isInSelectedWeek(dayDate.getTime())

      return {
        isCurrentMonth: isSameMonth,
        isSelected,
        isInWeek,
        isToday: this.isToday(dayDate)
      }
    },
    // 判断日期是否在选中周范围内
    isInSelectedWeek(timestamp) {
      if (!this.selectedWeek) return false
      const targetDate = new Date(timestamp)
      return targetDate >= new Date(this.selectedWeek.start) && 
             targetDate <= new Date(this.selectedWeek.end)
    },
    // 判断日期是否是今天
    isToday(date) {
      const today = new Date()
      return date.toDateString() === today.toDateString()
    },

    // 切换视图
    switchView(mode) {
      this.viewMode = mode

    },
    // 选择日期
    selectDate(timestamp) {
        const clickedDate = new Date(timestamp)
        this.updateCurrentMonthIfNeeded(clickedDate)
        this.selectedDate = timestamp
        this.updateSelectedWeek(clickedDate)
    },
    // 选择日期后的派发函数以及派发后的数据格式
    selectedData() {
      const dateMap = {
        'day': this.selectedDate,
        'week': this.selectedWeek,
        'month': this.selectedDate,
        'year': this.selectedDate
      };
      let selectedValue = dateMap[this.viewMode];
      let startTime, endTime;

      // 将毫秒转换为秒 (除以1000 并取整)
      const toSeconds = (time) => Math.floor(time / 1000);
      switch (this.viewMode) {
        case 'day':
          startTime = new Date(selectedValue);
          startTime.setHours(0, 0, 0, 0);
          endTime = new Date(selectedValue);
          endTime.setHours(23, 59, 59, 999);
          break;
        
        case 'month':
          startTime = new Date(selectedValue);
          startTime.setDate(1);
          startTime.setHours(0, 0, 0, 0);
          endTime = new Date(selectedValue);
          endTime.setMonth(endTime.getMonth() + 1);
          endTime.setDate(0);
          endTime.setHours(23, 59, 59, 999);
          break;
        
        case 'year':
          startTime = new Date(selectedValue);
          startTime.setMonth(0, 1);
          startTime.setHours(0, 0, 0, 0);
          endTime = new Date(selectedValue);
          endTime.setMonth(11, 31);
          endTime.setHours(23, 59, 59, 999);
          break;
        
        case 'week':
          startTime = new Date(selectedValue.start);
          endTime = new Date(selectedValue.end);
          endTime.setHours(23, 59, 59, 999);
          break;
      }
      if(this.viewMode=='week'){
        
        this.$el.dispatchEvent(new CustomEvent('calendar-date-selected', {
          detail: { 
            date: {
              start: toSeconds(startTime.getTime()),
              end: toSeconds(endTime.getTime())+1,
              type:this.viewMode,
              count:this.getWeekNumber(startTime.getTime())
            }
          },
          bubbles: true
        }));
      }else{
        this.$el.dispatchEvent(new CustomEvent('calendar-date-selected', {
          detail: { 
            date: {
              start: toSeconds(startTime.getTime()),
              end: toSeconds(endTime.getTime())+1,
              type:this.viewMode
            }
          },
          bubbles: true
        }));
      }
      
    },
    // 更新当前月份
    updateCurrentMonthIfNeeded(clickedDate) {
      const currentDate = this.currentDate()
      if (clickedDate.getMonth() !== currentDate.getMonth() || 
          clickedDate.getFullYear() !== currentDate.getFullYear()) {
        this.currentTimestamp = new Date(
          clickedDate.getFullYear(),
          clickedDate.getMonth(),
          1
        ).getTime()
      }
    },
    // 更新选中的周范围
    updateSelectedWeek(date) {
      const day = date.getDay() || 7; // 处理周日为0的情况，转换为7
      const weekStart = new Date(date);
      weekStart.setDate(date.getDate() - day + 1); // 调整为周一开始
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6); // 周日结束
      
      this.selectedWeek = {
        start: weekStart.getTime(),
        end: weekEnd.getTime()
      }
    },
    // 导航到上/下一个月、上/下一个20年、上/下一个周
    navigate(direction, isSmallStep = false) {
      const date = new Date(this.currentTimestamp)
      const stepMap = {
        year: () => date.setFullYear(date.getFullYear() + direction * (isSmallStep ? 1 : 20)),
        month: () => date.setFullYear(date.getFullYear() + direction),
        week: () => date.setMonth(date.getMonth() + direction),
        day: () => date.setMonth(date.getMonth() + direction)
      }
      
      stepMap[this.viewMode]?.()
      this.currentTimestamp = date.getTime()
    },
    // 获取周数
    getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    },

    // 格式化方法
    formatDate(timestamp, format) {
      const date = new Date(timestamp)
      return format === 'year' ? date.getFullYear() :
        format === 'month' ? date.getMonth() + 1 :  // 修改这一行
        date.toLocaleDateString()
    }
  }
}

</script>
</html>