<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电脑端日期选择器</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div x-data="dateSelector()" class="flex flex-col items-center justify-center p-4"
        @click.away="calendarShow=false;showOptions=false">
        <div class="flex items-start space-x-4 whitespace-nowrap mb-4">
            <!-- 选择模式按钮 -->
            <div @click.stop="showOptions = !showOptions;calendarShow=false" 
                class="relative p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition duration-200 ease-in-out w-full text-center"
            >
                <div class="whitespace-nowrap">选择日历模式</div>
                <!-- 模式选项 -->
                <div class="absolute top-0 translate-y-1/4 space-y-3 flex flex-col"
                    x-show="showOptions"
                    x-data="{
                        thisMode:['day','week','month','year'],
                        thisText:['按日选择','按周选择','按月选择','按年选择'],
                    }">
                    <template x-for="(data,index) in thisMode" :key="index">
                        <button @click.stop="selectMode(data);"
                        x-text="thisText[index]"
                        class="w-full p-3 bg-gray-200 text-gray-800 rounded-xl shadow-sm hover:bg-gray-300 transition duration-200 ease-in-out"
                        >
                        </button>
                    </template>
                </div>
            </div>
            <!-- 显示当前选中的日期或周 -->
            <div class=" p-3 border rounded-lg bg-gray-50 hover:bg-gray-100 transition duration-200 ease-in-out"
            @click="selectMode('day');">
                <span x-show="mode!=='week'" 
                        x-text="selectedData.year.time + '年' + (selectedData.month + 1) + '月' + selectedData.day + '日'"></span>
                <span x-show="mode === 'week'" x-text="selectedData?.week?.range"></span>
            </div>
        </div>

        <!-- 日历控件 -->
        <div x-show="calendarShow" class="mt-4">
            <!-- 按日/周选择 -->
            <div x-show="calendarMode === 'day' || calendarMode === 'week' ? modeChange(calendarMode, calendarMode) : false"
            class="bg-gray-800 p-4 shadow-md rounded-md">
                <div class="flex justify-between items-center mb-4">
                    <button @click="changeMonth(-1)" class="p-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">&lt;</button>
                    <div class="text-lg font-semibold text-gray-200">
                        <span class="hover:text-blue-500" @click="calendarMode='year'" x-text="displayYear+'年'"></span>
                        <span class="hover:text-blue-500" @click="calendarMode='month'" x-text="monthNames[displayMonth]"></span>
                    </div>
                    <button @click="changeMonth(1)" class="p-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">&gt;</button>
                </div>
                <!-- 对应的星期数 -->
                <div class="grid grid-cols-7 gap-2 text-center text-gray-400 font-medium">
                    <template x-for="day in weekDays" :key="day">
                        <div class="uppercase text-sm"><span x-text="day"></span></div>
                    </template>
                </div>
        
                <div class="grid grid-cols-7 text-center"
                :class="{'gap-2 mt-2': calendarMode==='day'
                        ,'space-y-2': calendarMode==='week'
                }">
                    <!-- 处理空白天数 -->
                    <template x-for="blank in blankDays" :key="blank">
                        <div class="text-transparent">0</div>
                    </template>
                
                    <!-- 处理日期 -->
                    <template x-for="(day, index) in daysInMonth" :key="index">
                        <div
                            @click="select(day)"
                            class="w-10 text-center text-gray-100 p-2"
                            :class="{
                                // 按日选择
                                'rounded-full bg-blue-600 ': calendarMode === 'day' && day === displayDay,
                                ' hover:bg-gray-700 text-gray-300 rounded-full': calendarMode === 'day' && day !== displayDay,
                                
                                // 按周选择
                                'bg-blue-600': calendarMode === 'week' && isDateInSelectedWeek(day),
                                'rounded-l-full': calendarMode === 'week' && isDateInSelectedWeek(day) && day === new Date(selectedData?.week?.start).getDate(),
                                'rounded-r-full': calendarMode === 'week' && isDateInSelectedWeek(day) && day === new Date(selectedData?.week?.end).getDate(),
                                'hover:bg-gray-700 text-gray-300': calendarMode === 'week' && !isDateInSelectedWeek(day)
                            }"
                        >
                            <span x-text="day"></span>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- 按月选择 -->
            <div x-show="modeChange(calendarMode,'month')">
                <div class="bg-gray-800 p-4 shadow-md rounded-md">
                    <div class="text-center mb-4">
                        <div class="flex justify-between items-center">
                            <button @click="changeYear(-1)" class="p-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">&lt;</button>
                            <span @click="calendarMode='year'" class="text-lg font-semibold text-gray-200 hover:text-blue-500" x-text="displayYear+'年'"></span>
                            <button @click="changeYear(1)" class="p-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">&gt;</button>
                        </div>
                    </div>
    
                    <!-- 按月选择 -->
                    <div class="grid grid-cols-3 gap-4">
                        <template x-for="(month, index) in monthNames" :key="index">
                        <div
                            @click="select(index)"
                            :class="{
                            'bg-blue-600 text-gray-100': displayMonth === index,
                            'bg-gray-700 text-gray-300': displayMonth !== index
                            }"
                            class="p-4 text-center rounded shadow cursor-pointer hover:scale-110"
                        >
                            <span x-text="month"></span>
                        </div>
                        </template>
                    </div>
                </div>
            </div>
        
            <!-- 按年选择 -->
            <div x-show="modeChange(calendarMode,'year')">
                <div class="bg-gray-800 p-4 shadow-md rounded-md">
                    <div class="text-center mb-4">
                        <div class="flex justify-between items-center">
                            <button @click="prevRange" class="p-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">&lt;</button>
                            <span class="text-lg font-semibold text-gray-200" x-text="`${selectedData?.year?.startYear}年 - ${selectedData?.year?.endYear}年`"></span>
                            <button @click="nextRange" class="p-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">&gt;</button>
                        </div>
                    </div>
        
                    <!-- 显示年份 -->
                    <div class="grid grid-cols-3 gap-4">
                        <template x-for="year in yearRange" :key="year">
                        <div
                            @click="select(year)"
                            :class="{
                            'bg-blue-600 text-gray-100': displayYear === year,
                            'bg-gray-700 text-gray-300': displayYear !== year
                            }"
                            class="p-4 text-center rounded shadow cursor-pointer hover:scale-110"
                        >
                            <span x-text="year+' 年'"></span>
                        </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    function dateSelector(mode = 'day') {
        function convertToEastEightZone(date) {
            // 如果传入的是无效的日期，使用当前真实日期
            if (typeof date !== 'object' || !(date instanceof Date) || isNaN(date.getTime())) {
                date = new Date(); // 获取当前日期
            }

            // 获取 UTC 时间并转换为东八区时间
            const utcDate = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
            return new Date(utcDate + 8 * 60 * 60 * 1000); // 转换为东八区时间
        }

        return {
            displayYear: new Date().getFullYear(), // 当前年份
            displayMonth: new Date().getMonth(),   // 当前月份（0-11，0代表一月）
            displayDay: new Date().getDate(),      // 当前日期
            selectedData: null,                    // 存储选择器的选中数据
            weekDays: ['日', '一', '二', '三', '四', '五', '六'], 
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'], 
            daysInMonth: [], 
            blankDays: [],  
            mode,            // 当前选择器模式：可以是 'day'（日期模式）、'month'（月份模式）、'week'（周模式）、'year'

            // 初始化函数，计算月份的天数并设置默认选择项
            init() {
                this.selectedData={
                    year: {
                        time:this.displayYear,
                        startYear: this.displayYear - 5, // 显示的年份范围开始
                        endYear: this.displayYear + 5, // 显示的年份范围结束
                    },
                    month: this.displayMonth,
                    day: this.displayDay,
                    week: null,
                }
                // 初始化week
                this.setSelectedWeek();
                this.calculateMonthDays(); 
                this.initializeSelection(); 
                console.log("初始化完成，当前选择器模式：",this.mode,"初始化数据：",this.selectedData);
            },
            // 控制控件显示相关逻辑
            showOptions: false, // 控制选项显示
            calendarMode: null, // 当前日历模式
            calendarShow: false,// 日历显示状态
            // 选着模式，关闭选项卡，打开日历
            selectMode(mode) {
                this.calendarMode = mode;
                this.calendarShow =true;
                this.showOptions = false; // 关闭选项显示
            },

            // 切换模式时调用该函数,并返回返回值进行判断
            modeChange(changeMode='day',_mode='day'){
                this.mode=changeMode;
                this.calculateMonthDays();
                return this.mode==_mode;
            },

            // 初始化选择项，根据选择器的模式设置初始选中状态
            initializeSelection() {
                const handlers = {
                    day: () => (this.selectedData.day = this.displayDay),
                    week: () => this.setSelectedWeek(new Date(this.displayYear, this.displayMonth, this.displayDay)),
                    month: () => (this.selectedData.month = this.displayMonth),
                    year: () => (this.selectedData.year.time = this.displayYear),
                };
                handlers[this.mode]?.();
            },

            // 计算当前月份的天数和空白天数
            calculateMonthDays() {
                const days = new Date(this.displayYear, this.displayMonth + 1, 0).getDate(); 
                const startDay = new Date(this.displayYear, this.displayMonth, 1).getDay();  
                this.blankDays = Array.from({ length: startDay }, (_, i) => i + 1);          
                this.daysInMonth = Array.from({ length: days }, (_, i) => i + 1);            
            },

            // 改变当前月份（向前或向后切换）
            changeMonth(offset) {
                const newMonth = this.displayMonth + offset;
                
                // 确保月份在 0 到 11 范围内
                this.displayMonth = (newMonth + 12) % 12;

                // 计算年份的变化
                const monthOverflow = Math.floor(newMonth / 12); // 确定年份是否溢出
                this.displayYear += monthOverflow;

                this.calculateMonthDays();

                // 根据当前月份是否与选中的月份一致，决定是否重置显示日期
                this.displayDay = (this.displayMonth === this.selectedData.month) ? this.selectedData.day : null;
            },

            // 改变当前年份
            changeYear(offset) {
                this.displayYear += offset;

                // 如果年份改变，重置月份
                this.displayMonth = (this.displayYear !== this.selectedData.year.time) ? null : this.selectedData.month;
            },


            // 范围改变年份
            prevRange() {
                this.selectedData.year.startYear -= 10;
                this.selectedData.year.endYear -= 10;
            },
            nextRange() {
                this.selectedData.year.startYear += 10;
                this.selectedData.year.endYear += 10;
            },
            get yearRange() {
                // 计算当前范围内的年份列表
                return Array.from({ length: this.selectedData.year.endYear - this.selectedData.year.startYear + 1 }, (_, i) => this.selectedData.year.startYear + i);
            },

            // 选择一个日期、月份或周，具体逻辑根据模式执行
            select(data) {
                if(this.displayDay==null)
                {
                    this.displayDay=this.selectedData.day;
                }
                // 点击后更新日期属性
                this.updateSelection(this.mode,data);
            },
            updateSelection(type, data) {
                // 格式化数字
                const formatNumber = (num) => String(num).padStart(2, '0');

                // 更新选择数据并自动选取对应周
                const updateCommonData = () => {
                    this.selectedData.year.time = this.displayYear;
                    this.selectedData.month = this.displayMonth;
                    this.selectedData.day = this.displayDay;
                    this.setSelectedWeek(new Date(this.displayYear, this.displayMonth, this.displayDay));
                };

                // 检查日期是否越界并进行修正
                const correctDayForMonth = (year, month, day) => {
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    return Math.min(day, daysInMonth); // 返回不超过该月最大天数的日子
                };

                // 日志记录功能
                const logSelectionData = (label, value) => {
                    this.logSelection(label, value);
                };

                // 更新日期信息
                const updateDateSelection = (year, month, day) => {
                    this.displayYear = year || this.displayYear;
                    this.displayMonth = month >= 0 && month < 12 ? month : this.displayMonth;
                    this.displayDay = correctDayForMonth(this.displayYear, this.displayMonth, day || this.displayDay);
                    this.selectedData.day = this.displayDay;
                    updateCommonData();
                };

                // 更新选择信息
                const updateSelectionByType = (type, data) => {
                    let label, formattedDate;
                    switch (type) {
                        case 'day':
                            updateDateSelection(this.displayYear, this.displayMonth, data);
                            label = '日期';
                            formattedDate = `${this.displayYear}-${formatNumber(this.displayMonth + 1)}-${formatNumber(this.displayDay)}`;
                            break;
                        case 'month':
                            updateDateSelection(this.displayYear, data, this.displayDay);
                            label = '月份';
                            formattedDate = `${this.displayYear}-${formatNumber(data + 1)}-${formatNumber(this.displayDay)}`;
                            break;
                        case 'year':
                            updateDateSelection(data, this.displayMonth, this.displayDay);
                            label = '年份';
                            formattedDate = `${this.displayYear}-${formatNumber(this.displayMonth + 1)}-${formatNumber(this.displayDay)}`;
                            break;
                        case 'week':
                            this.selectedData.day = data;
                            this.displayDay = data;
                            updateCommonData();
                            label = '周';
                            formattedDate = this.selectedData?.week?.range;
                            break;
                        default:
                            console.error(`未知的选择类型: ${type}`);
                            return; // 遇到错误的类型直接返回
                    }

                    if (label && formattedDate) {
                        logSelectionData(label, formattedDate);
                    }
                };

                // 执行选择操作
                updateSelectionByType(type, data);
            },


            // 设置选中周的范围（开始日期和结束日期）
            setSelectedWeek(date= new Date(this.displayYear, this.displayMonth, this.displayDay)) {
                // 转化为东八时区
                const offsetDate = convertToEastEightZone(date);
                const dayOfWeek = offsetDate.getUTCDay();
                const offset = (dayOfWeek === 0 ? 6 : dayOfWeek - 1); // 周一为一周的开始
                // 计算这周开始和结束时间
                const startOfWeek = new Date(offsetDate);
                startOfWeek.setUTCDate(offsetDate.getUTCDate() - offset);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setUTCDate(startOfWeek.getUTCDate() + 6);
                // 格式化日期范围
                const range = `${startOfWeek.toISOString().slice(0, 10)} 至 ${endOfWeek.toISOString().slice(0, 10)}`;
                // 更新选中的周数据
                this.selectedData.week = { range, start: startOfWeek, end: endOfWeek };
            },

            // 打印选中的类型和值（调试用）
            logSelection(type, value) {
                console.log(`选中${type}: ${value}`);
            },

            // 检查某日期是否属于选中的周范围
            isDateInSelectedWeek(day) {
                if (this.mode !== 'week' || !this.selectedData.week ) return false; 
                const clickedDate = new Date(this.displayYear, this.displayMonth, day); 
                const offsetDate = convertToEastEightZone(clickedDate); 
                return offsetDate >= this.selectedData.week.start && offsetDate <= this.selectedData.week.end; 
            },
        };
    }
</script>
  
  
</html>

