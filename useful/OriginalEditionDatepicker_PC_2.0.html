<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电脑端日期选择器</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 sm:p-8">
    <div x-data="dateSelector()" x-init="init()" class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl hover:shadow-2xl transition-shadow duration-300 p-6">
        <!-- 胶囊式模式切换 -->
        <div class="flex gap-1 mb-8 p-1 bg-gray-100/50 rounded-full backdrop-blur-sm">
            <template x-for="m in ['day','week','month','year']" :key="m">
                <button 
                    @click="mode = m; initializeSelection()"
                    class="px-5 py-2.5 text-sm font-medium rounded-full transition-all duration-300 transform hover:scale-[1.02]"
                    :class="{
                        'bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-md': mode === m,
                        'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50': mode !== m
                    }"
                    x-text="m === 'day' ? '日' : m === 'week' ? '周' : m === 'month' ? '月' : '年'"
                ></button>
            </template>
        </div>

        <!-- 导航容器统一样式 -->
        <template x-if="['day','week','month'].includes(mode)">
            <div class="flex items-center justify-between mb-8 bg-gray-50/80 p-3 rounded-xl backdrop-blur-sm border border-gray-100">
                <div class="flex gap-1">
                    <button @click="changeYear(-1)" class="p-2.5 rounded-xl hover:bg-gray-200/50 transition-colors">
                        <span class="text-xl text-gray-600 hover:text-blue-600 transition-colors">&laquo;</span>
                    </button>
                    <button @click="changeMonth(-1)" class="p-2.5 rounded-xl hover:bg-gray-200/50 transition-colors">
                        <span class="text-xl text-gray-600 hover:text-blue-600 transition-colors">&lsaquo;</span>
                    </button>
                </div>
                
                <div class="flex items-baseline gap-2 text-lg font-semibold">
                    <span x-text="displayYear" class="text-blue-600 text-xl"></span>
                    <span class="text-gray-500">年</span>
                    <span x-text="monthNames[displayMonth]" class="text-gray-700 ml-2"></span>
                </div>

                <div class="flex gap-1">
                    <button @click="changeMonth(1)" class="p-2.5 rounded-xl hover:bg-gray-200/50 transition-colors">
                        <span class="text-xl text-gray-600 hover:text-blue-600 transition-colors">&rsaquo;</span>
                    </button>
                    <button @click="changeYear(1)" class="p-2.5 rounded-xl hover:bg-gray-200/50 transition-colors">
                        <span class="text-xl text-gray-600 hover:text-blue-600 transition-colors">&raquo;</span>
                    </button>
                </div>
            </div>
        </template>
        <!-- 年视图导航 -->
        <template x-if="mode === 'year'">
            <div class="flex items-center justify-between mb-6 bg-gray-50 p-3 rounded-lg">
                <div class="gap-2">
                    <button @click="prevRange" class="p-2 rounded-lg hover:bg-gray-100">
                        <span class="text-xl text-gray-600">&laquo;</span>
                    </button>
                    <button @click="changeYear(-1)" class="p-2 rounded-lg hover:bg-gray-100">
                        <span class="text-xl text-gray-600">&lsaquo;</span>
                    </button>
                </div>
                <div class="flex items-baseline gap-2 text-lg font-semibold">
                    <span x-text="displayYear" class="text-blue-600 text-xl"></span>
                    <span class="text-gray-500">年</span>
                    <span x-text="monthNames[displayMonth]" class="text-gray-700 ml-2"></span>
                </div>
                <div class="gap-2">
                    <button @click="changeYear(1)" class="p-2 rounded-lg hover:bg-gray-100">
                        <span class="text-xl text-gray-600">&rsaquo;</span>
                    </button>
                    <button @click="nextRange" class="p-2 rounded-lg hover:bg-gray-100">
                        <span class="text-xl text-gray-600">&raquo;</span>
                    </button>
                </div>
            </div>
        </template>

        <!-- 日/周视图网格优化 -->
        <template x-if="['day','week'].includes(mode)">
            <div class="grid grid-cols-7 gap-1 mb-6">
                <template x-for="day in weekDays" :key="day">
                    <div class="text-center text-sm font-semibold text-gray-500 py-3.5 
                              bg-gray-50/80 backdrop-blur-sm rounded-t-lg border-b border-gray-100">
                        <span x-text="day"></span>
                    </div>
                </template>
                
                <template x-for="dayInfo in daysInMonth" :key="`${dayInfo.year}-${dayInfo.month}-${dayInfo.day}`">
                    <div 
                        @click="select(dayInfo)"
                        class="relative aspect-square flex items-center justify-center 
                              transition-all duration-300 hover:z-10 hover:shadow-lg cursor-pointer
                              border border-gray-100/50 bg-white/80 backdrop-blur-sm
                              hover:bg-blue-50/50 hover:border-blue-200/50"
                        :class="{
                            'text-gray-300': !dayInfo.isCurrentMonth,
                            '!bg-gradient-to-br from-blue-600 to-blue-500 !text-white !border-transparent !shadow-md': isSelectedDate(dayInfo),
                            'ring-2 ring-blue-200/50 ring-inset': mode === 'week' && isDateInSelectedWeek(dayInfo)
                        }"
                    >
                        <span x-text="dayInfo.day" class="relative z-10"></span>
                        <template x-if="dayInfo.day === selectedData.day && dayInfo.isCurrentMonth">
                            <div class="absolute bottom-2 w-2 h-2 bg-white/80 rounded-full shadow-sm"></div>
                        </template>
                    </div>
                </template>
            </div>
        </template>

        <!-- 月视图优化 -->
        <template x-if="mode === 'month'">
            <div class="grid grid-cols-3 gap-3">
                <template x-for="(month, index) in monthNames" :key="index">
                    <button 
                        @click="updateSelection('month', index)"
                        class="p-5 text-center rounded-xl transition-all duration-300 
                               border border-gray-100 hover:border-blue-200/50 hover:shadow-md
                               backdrop-blur-sm bg-white/80 hover:bg-blue-50/50"
                        :class="{
                            '!bg-gradient-to-br from-blue-600 to-blue-500 !text-white !border-transparent !shadow-md': displayMonth === index
                        }"
                        x-text="month"
                    ></button>
                </template>
            </div>
        </template>

        <!-- 年视图优化 -->
        <template x-if="mode === 'year'">
            <div class="space-y-4">
                <div class="grid grid-cols-3 sm:grid-cols-5 gap-3">
                    <template x-for="year in yearRange" :key="year">
                        <button 
                            @click="updateSelection('year', year)"
                            class="p-4 rounded-xl transition-all duration-300 hover:scale-[1.03] 
                                   border border-gray-100 backdrop-blur-sm bg-white/80
                                   hover:shadow-md hover:border-blue-200/50 relative"
                            :class="{
                                '!bg-gradient-to-br from-blue-600 to-blue-500 !text-white !border-transparent !shadow-lg': displayYear === year,
                                '!border-dashed !border-blue-300': year === selectedData.year.time
                            }"
                        >
                            <span class="text-sm font-medium" x-text="year"></span>
                            
                            <template x-if="year === selectedData.year.time">
                                <div class="absolute top-0 right-0 -translate-y-1/2 translate-x-1/2">
                                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center 
                                              shadow-sm border border-blue-200/50">
                                        <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                                    </div>
                                </div>
                            </template>
                        </button>
                    </template>
                </div>
            </div>
        </template>

        <!-- 底部信息优化 -->
        <div class="mt-8 pt-6 border-t border-gray-100/50">
            <template x-if="mode !== 'week'">
                <div class="text-sm font-medium text-gray-600 bg-blue-50/50 p-4 rounded-xl 
                          backdrop-blur-sm border border-blue-100/50 shadow-inner">
                    📅 <span class="text-blue-600 font-semibold" 
                          x-text="`${selectedData.year.time}-${String(selectedData.month+1).padStart(2,'0')}-${String(selectedData.day).padStart(2,'0')}`"></span>
                </div>
            </template>
            <template x-if="mode === 'week'">
                <div class="text-sm font-medium text-blue-600 bg-blue-50/50 p-4 rounded-xl 
                          backdrop-blur-sm border border-blue-100/50 shadow-inner" 
                     x-text="selectedData.week?.range"></div>
            </template>
        </div>
    </div>
</body>

<script>
    function dateSelector(mode = 'day') {
        function convertToEastEightZone(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                date = new Date();
            }
            const utcDate = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
            return new Date(utcDate + 8 * 60 * 60 * 1000);
        }

        return {
            displayYear: new Date().getFullYear(), // 当前年份
            displayMonth: new Date().getMonth(),   // 当前月份（0-11，0代表一月）
            displayDay: new Date().getDate(),      // 当前日期
            selectedData: null,                    // 存储选择器的选中数据
            weekDays: ['一', '二', '三', '四', '五', '六', '日'], // 调整为周一到周日
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'], 
            daysInMonth: [], 
            blankDays: [],  
            mode,            // 当前选择器模式：可以是 'day'（日期模式）、'month'（月份模式）、'week'（周模式）、'year'

            // 初始化函数，计算月份的天数并设置默认选择项
            init() {
            this.selectedData = {
                year: {
                    time: this.displayYear,
                    startYear: this.displayYear - Math.abs(this.displayYear % 10) - 10,
                    endYear: (this.displayYear - Math.abs(this.displayYear % 10)) + 9
                },              
                month: this.displayMonth,
                day: this.displayDay,
                week: null,
            };
            this.setSelectedWeek();
            this.calculateMonthDays();
            this.initializeSelection();
        },
            // 控制控件显示相关逻辑
            showOptions: false, // 控制选项显示
            calendarMode: null, // 当前日历模式
            calendarShow: false,// 日历显示状态
            // 选着模式，关闭选项卡，打开日历
            selectMode(mode) {
                this.calendarMode = mode;
                this.calendarShow =true;
                this.showOptions = false; // 关闭选项显示
            },

            // 切换模式时调用该函数,并返回返回值进行判断
            modeChange(changeMode='day',_mode='day'){
                this.mode=changeMode;
                this.calculateMonthDays();
                return this.mode==_mode;
            },

            // 初始化选择项，根据选择器的模式设置初始选中状态
            initializeSelection() {
                // 同步display到当前选中的值
                this.displayYear = this.selectedData.year.time;
                this.displayMonth = this.selectedData.month;
                this.displayDay = this.selectedData.day;

                const handlers = {
                    day: () => this.selectedData.day = this.displayDay,
                    week: () => this.setSelectedWeek(new Date(this.displayYear, this.displayMonth, this.displayDay)),
                    month: () => this.selectedData.month = this.displayMonth,
                    year: () => this.selectedData.year.time = this.displayYear,
                };
                handlers[this.mode]?.();
                this.calculateMonthDays();
            },

            // 计算当前月份的天数和空白天数
            calculateMonthDays() {
                const currentYear = this.displayYear;
                const currentMonth = this.displayMonth;
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
                
                // 计算当前月第一天在周一到周日中的位置（周一=0，周日=6）
                const firstDayWeekday = (firstDayOfMonth.getDay() + 6) % 7;
                // 计算需要显示的上个月天数
                const prevMonthDays = Array.from({length: firstDayWeekday}, (_, i) => {
                    const day = new Date(currentYear, currentMonth, -firstDayWeekday + i + 1);
                    return {
                        day: day.getDate(),
                        month: day.getMonth(),
                        year: day.getFullYear(),
                        isCurrentMonth: false
                    };
                });

                // 当前月天数
                const currentMonthDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                const currentDays = Array.from({length: currentMonthDays}, (_, i) => ({
                    day: i + 1,
                    month: currentMonth,
                    year: currentYear,
                    isCurrentMonth: true
                }));

                // 计算需要显示的下个月天数
                const totalDays = prevMonthDays.length + currentDays.length;
                const nextMonthDays = Array.from({length: 42 - totalDays}, (_, i) => {
                    const day = new Date(currentYear, currentMonth + 1, i + 1);
                    return {
                        day: day.getDate(),
                        month: day.getMonth(),
                        year: day.getFullYear(),
                        isCurrentMonth: false
                    };
                });

                this.daysInMonth = [...prevMonthDays, ...currentDays, ...nextMonthDays];
            },

            // 改变当前月份（向前或向后切换）
            changeMonth(offset) {
                const newMonth = this.displayMonth + offset;
                
                // 确保月份在 0 到 11 范围内
                this.displayMonth = (newMonth + 12) % 12;

                // 计算年份的变化
                const monthOverflow = Math.floor(newMonth / 12); // 确定年份是否溢出
                this.displayYear += monthOverflow;

                this.calculateMonthDays();

                // 根据当前月份是否与选中的月份一致，决定是否重置显示日期
                this.displayDay = (this.displayMonth === this.selectedData.month) ? this.selectedData.day : null;
            },

            // 改变当前年份
            changeYear(offset) {
                this.displayYear += offset;
                this.calculateMonthDays();
                if(this.displayYear>this.selectedData.year.endYear)
                {
                    this.nextRange();
                }
                else if(this.displayYear<this.selectedData.year.startYear)
                {
                    this.prevRange();
                }
                // 如果年份改变，重置月份
                // this.displayMonth = (this.displayYear !== this.selectedData.year.time) ? null : this.selectedData.month;
            },


            // 范围改变年份
            prevRange() {
                this.selectedData.year.startYear -= 20;
                this.selectedData.year.endYear -= 20;
            },
            nextRange() {
                this.selectedData.year.startYear += 20;
                this.selectedData.year.endYear += 20;
            },
            get yearRange() {
                // 计算当前范围内的年份列表
                return Array.from({ length: this.selectedData.year.endYear - this.selectedData.year.startYear + 1 }, (_, i) => this.selectedData.year.startYear + i);
            },

            // 修改后的选择方法
            select(dayInfo) {
                // 处理跨月点击时直接更新显示的年月
                if (!dayInfo.isCurrentMonth) {
                    this.displayYear = dayInfo.year;
                    this.displayMonth = dayInfo.month;
                    this.calculateMonthDays();
                }
                
                // 更新显示日期
                this.displayDay = dayInfo.day;
                
                // 统一使用点击日期的实际年月日来设置周
                const actualDate = new Date(dayInfo.year, dayInfo.month, dayInfo.day);
                this.setSelectedWeek(actualDate);
                
                // 更新选中数据
                this.updateSelection(this.mode, dayInfo.day);
            },
            updateSelection(type, data) {
                // 格式化数字
                const formatNumber = (num) => String(num).padStart(2, '0');

                // 更新选择数据并自动选取对应周
                const updateCommonData = () => {
                    this.selectedData.year.time = this.displayYear; // 确保年份同步
                    this.selectedData.month = this.displayMonth;    // 月份同步
                    this.selectedData.day = this.displayDay;        // 日期同步
                    this.setSelectedWeek(new Date(this.displayYear, this.displayMonth, this.displayDay));
                };
                

                // 检查日期是否越界并进行修正
                const correctDayForMonth = (year, month, day) => {
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    return Math.min(day, daysInMonth); // 返回不超过该月最大天数的日子
                };

                // 日志记录功能
                const logSelectionData = (label, value) => {
                    this.logSelection(label, value);
                };

                // 更新日期信息
                const updateDateSelection = (year, month, day) => {
                    this.displayYear = year || this.displayYear;
                    this.displayMonth = month >= 0 && month < 12 ? month : this.displayMonth;
                    this.displayDay = correctDayForMonth(this.displayYear, this.displayMonth, day || this.displayDay);
                    this.selectedData.day = this.displayDay;
                    updateCommonData();
                };

                // 更新选择信息
                const updateSelectionByType = (type, data) => {
                    let label, formattedDate;
                    switch (type) {
                        case 'day':
                            updateDateSelection(this.displayYear, this.displayMonth, data);
                            label = '日期';
                            formattedDate = `${this.displayYear}-${formatNumber(this.displayMonth + 1)}-${formatNumber(this.displayDay)}`;
                            break;
                        case 'month':
                            const oldMonth = this.displayMonth;
                            this.displayMonth = data;
                            // 处理年份自动调整
                            if (oldMonth === 11 && data === 0) {
                                this.displayYear += 1;
                            } else if (oldMonth === 0 && data === 11) {
                                this.displayYear -= 1;
                            }
                            this.displayDay = correctDayForMonth(this.displayYear, this.displayMonth, this.displayDay);
                            this.selectedData.month = this.displayMonth;
                            this.selectedData.year.time = this.displayYear;
                            this.calculateMonthDays();
                            break;
                        case 'year':
                            updateDateSelection(data, this.displayMonth, this.displayDay);
                            label = '年份';
                            formattedDate = `${this.displayYear}-${formatNumber(this.displayMonth + 1)}-${formatNumber(this.displayDay)}`;
                            break;
                        case 'week':
                            this.selectedData.day = data;
                            this.displayDay = data;
                            updateCommonData();
                            label = '周';
                            formattedDate = this.selectedData?.week?.range;
                            break;
                        default:
                            console.error(`未知的选择类型: ${type}`);
                            return; // 遇到错误的类型直接返回
                    }

                    if (label && formattedDate) {
                        logSelectionData(label, formattedDate);
                    }
                };

                // 执行选择操作
                updateSelectionByType(type, data);
            },


            // 设置选中周的范围（开始日期和结束日期）
            setSelectedWeek(date) {
                const offsetDate = convertToEastEightZone(date);
                const dayOfWeek = offsetDate.getUTCDay();
                const offset = (dayOfWeek === 0 ? 6 : dayOfWeek - 1); // 周一开始
                
                // 计算周范围时使用实际点击日期的年月
                const startOfWeek = new Date(offsetDate);
                startOfWeek.setUTCDate(offsetDate.getUTCDate() - offset);
                
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setUTCDate(startOfWeek.getUTCDate() + 6);

                // 确保周范围显示正确的年月
                this.selectedData.year.time = offsetDate.getUTCFullYear();
                this.selectedData.month = offsetDate.getUTCMonth();
                this.selectedData.day = offsetDate.getUTCDate();

                // 格式化范围时显示完整的年月信息
                const format = d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
                this.selectedData.week = { 
                    range: `${format(startOfWeek)} 至 ${format(endOfWeek)}`,
                    start: startOfWeek,
                    end: endOfWeek
                };
            },

            // 打印选中的类型和值（调试用）
            logSelection(type, value) {
                console.log(`选中${type}: ${value}`);
            },

            // 检查某日期是否属于选中的周范围
            isDateInSelectedWeek(dayInfo) {
                if (this.mode !== 'week' || !this.selectedData.week) return false;
                
                // 使用日期对象的完整信息进行比较
                const clickedDate = new Date(dayInfo.year, dayInfo.month, dayInfo.day);
                const dateToCheck = convertToEastEightZone(clickedDate);
                
                return dateToCheck >= this.selectedData.week.start && 
                    dateToCheck <= this.selectedData.week.end;
            },
            isSelectedDate(dayInfo) {
                return dayInfo.year === this.selectedData.year.time &&
                        dayInfo.month === this.selectedData.month &&
                        dayInfo.day === this.selectedData.day;
            },
        };
    }
</script>
  
  
</html>

